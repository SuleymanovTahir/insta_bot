{% extends "admin/base.html" %}

{% block title %}–í–æ—Ä–æ–Ω–∫–∞ –ø—Ä–æ–¥–∞–∂ - {{ salon_info.name }}{% endblock %}

{% block nav_funnel %}active{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üéØ –í–æ—Ä–æ–Ω–∫–∞ –ø—Ä–æ–¥–∞–∂</h1>
    <p>–ê–Ω–∞–ª–∏–∑ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏</p>
</div>

<!-- Funnel Stats -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-card-content">
            <div class="stat-card-info">
                <h3>{{ funnel.conversion_rates.visitor_to_engaged }}%</h3>
                <p>–ü–æ—Å–µ—Ç–∏—Ç–µ–ª—å ‚Üí –í–æ–≤–ª–µ—á—ë–Ω–Ω—ã–π</p>
            </div>
            <div class="stat-card-icon">
                <i class="fas fa-arrow-right"></i>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-card-content">
            <div class="stat-card-info">
                <h3>{{ funnel.conversion_rates.engaged_to_booking }}%</h3>
                <p>–í–æ–≤–ª–µ—á—ë–Ω–Ω—ã–π ‚Üí –ù–∞—á–∞–ª –∑–∞–ø–∏—Å—å</p>
            </div>
            <div class="stat-card-icon">
                <i class="fas fa-arrow-right"></i>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-card-content">
            <div class="stat-card-info">
                <h3>{{ funnel.conversion_rates.booking_to_booked }}%</h3>
                <p>–ù–∞—á–∞–ª –∑–∞–ø–∏—Å—å ‚Üí –ó–∞–ø–∏—Å–∞–ª—Å—è</p>
            </div>
            <div class="stat-card-icon">
                <i class="fas fa-arrow-right"></i>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-card-content">
            <div class="stat-card-info">
                <h3>{{ funnel.conversion_rates.booked_to_completed }}%</h3>
                <p>–ó–∞–ø–∏—Å–∞–ª—Å—è ‚Üí –ü–æ—Å–µ—Ç–∏–ª</p>
            </div>
            <div class="stat-card-icon">
                <i class="fas fa-check"></i>
            </div>
        </div>
    </div>
</div>

<!-- Funnel Visualization -->
<div class="funnel-container">
    <div class="funnel-container">
    <h2 style="font-size: 1.8em; margin-bottom: 40px; color: #1f2937;">
        <i class="fas fa-filter"></i> –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≤–æ—Ä–æ–Ω–∫–∏
    </h2>

    <div class="funnel-stage" draggable="true" ondragover="allowDrop(event)" ondrop="drop(event, 'visitors')">
        <div class="funnel-bar">
            <div class="funnel-info">
                <h3><i class="fas fa-eye"></i> –ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏</h3>
                <p>–ù–∞—á–∞–ª–∏ –¥–∏–∞–ª–æ–≥ —Å –±–æ—Ç–æ–º</p>
            </div>
            <div class="funnel-numbers">
                <div class="funnel-count">{{ funnel.visitors }}</div>
                <div class="funnel-rate">100%</div>
            </div>
        </div>
    </div>

    <div class="funnel-stage" draggable="true" ondragover="allowDrop(event)" ondrop="drop(event, 'engaged')">
        <div class="funnel-bar">
            <div class="funnel-info">
                <h3><i class="fas fa-comments"></i> –í–æ–≤–ª–µ—á—ë–Ω–Ω—ã–µ</h3>
                <p>–ü—Ä–æ–¥–æ–ª–∂–∏–ª–∏ –¥–∏–∞–ª–æ–≥</p>
            </div>
            <div class="funnel-numbers">
                <div class="funnel-count">{{ funnel.engaged }}</div>
                <div class="funnel-rate">{{ funnel.conversion_rates.visitor_to_engaged }}%</div>
            </div>
        </div>
    </div>

    <div class="funnel-stage" draggable="true" ondragover="allowDrop(event)" ondrop="drop(event, 'started_booking')">
        <div class="funnel-bar">
            <div class="funnel-info">
                <h3><i class="fas fa-edit"></i> –ù–∞—á–∞–ª–∏ –∑–∞–ø–∏—Å—å</h3>
                <p>–ó–∞–ø–æ–ª–Ω—è—é—Ç —Ñ–æ—Ä–º—É –∑–∞–ø–∏—Å–∏</p>
            </div>
            <div class="funnel-numbers">
                <div class="funnel-count">{{ funnel.started_booking }}</div>
                <div class="funnel-rate">{{ funnel.conversion_rates.engaged_to_booking }}%</div>
            </div>
        </div>
    </div>

    <div class="funnel-stage" draggable="true" ondragover="allowDrop(event)" ondrop="drop(event, 'booked')">
        <div class="funnel-bar">
            <div class="funnel-info">
                <h3><i class="fas fa-calendar-check"></i> –ó–∞–ø–∏—Å–∞–ª–∏—Å—å</h3>
                <p>–ó–∞–≤–µ—Ä—à–∏–ª–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</p>
            </div>
            <div class="funnel-numbers">
                <div class="funnel-count">{{ funnel.booked }}</div>
                <div class="funnel-rate">{{ funnel.conversion_rates.booking_to_booked }}%</div>
            </div>
        </div>
    </div>

    <div class="funnel-stage" draggable="true" ondragover="allowDrop(event)" ondrop="drop(event, 'completed')">
        <div class="funnel-bar">
            <div class="funnel-info">
                <h3><i class="fas fa-check-circle"></i> –ü–æ—Å–µ—Ç–∏–ª–∏</h3>
                <p>–ü—Ä–∏—à–ª–∏ –Ω–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä—É</p>
            </div>
            <div class="funnel-numbers">
                <div class="funnel-count">{{ funnel.completed }}</div>
                <div class="funnel-rate">{{ funnel.conversion_rates.booked_to_completed }}%</div>
            </div>
        </div>
    </div>
</div>

<!-- Insights -->
<div class="analytics-grid" style="margin-top: 40px;">
    <div class="chart-container">
        <h2><i class="fas fa-lightbulb"></i> –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é</h2>
        <div style="padding: 20px 0;">
            {% if funnel.conversion_rates.visitor_to_engaged < 70 %}
            <div class="message-box message-client" style="margin-bottom: 15px;">
                <div class="message-header">
                    <span><i class="fas fa-exclamation-triangle"></i> –ù–∏–∑–∫–∞—è –≤–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç—å</span>
                    <span class="badge badge-warning">–¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è</span>
                </div>
                <div class="message-text">
                    –ö–æ–Ω–≤–µ—Ä—Å–∏—è –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π –≤ –≤–æ–≤–ª–µ—á—ë–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–∏–∑–∫–∞—è ({{ funnel.conversion_rates.visitor_to_engaged }}%).
                    –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º —É–ª—É—á—à–∏—Ç—å –ø–µ—Ä–≤–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç–∞ –∏ —Å–¥–µ–ª–∞—Ç—å –µ–≥–æ –±–æ–ª–µ–µ –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–º.
                </div>
            </div>
            {% endif %}

            {% if funnel.conversion_rates.engaged_to_booking < 50 %}
            <div class="message-box message-bot" style="margin-bottom: 15px;">
                <div class="message-header">
                    <span><i class="fas fa-exclamation-circle"></i> –ü—Ä–æ–±–ª–µ–º–∞ —Å –Ω–∞—á–∞–ª–æ–º –∑–∞–ø–∏—Å–∏</span>
                    <span class="badge badge-warning">–¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è</span>
                </div>
                <div class="message-text">
                    –ú–Ω–æ–≥–∏–µ –∫–ª–∏–µ–Ω—Ç—ã –Ω–µ –ø–µ—Ä–µ—Ö–æ–¥—è—Ç –∫ –∑–∞–ø–∏—Å–∏ ({{ funnel.conversion_rates.engaged_to_booking }}%).
                    –£–ø—Ä–æ—Å—Ç–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–ø–∏—Å–∏ –∏ –¥–æ–±–∞–≤—å—Ç–µ –±–æ–ª—å—à–µ –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏—Ö —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ –≤ –¥–∏–∞–ª–æ–≥–µ.
                </div>
            </div>
            {% endif %}

            {% if funnel.conversion_rates.booking_to_booked < 60 %}
            <div class="message-box message-client" style="margin-bottom: 15px;">
                <div class="message-header">
                    <span><i class="fas fa-times-circle"></i> –í—ã—Å–æ–∫–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç –±—Ä–æ—à–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π</span>
                    <span class="badge badge-danger">–ö—Ä–∏—Ç–∏—á–Ω–æ</span>
                </div>
                <div class="message-text">
                    {{ 100 - funnel.conversion_rates.booking_to_booked | round }}% –∫–ª–∏–µ–Ω—Ç–æ–≤ –±—Ä–æ—Å–∞—é—Ç –∑–∞–ø–∏—Å—å –Ω–∞ –ø–æ–ª–ø—É—Ç–∏.
                    –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–ª–∏–Ω—É —Ñ–æ—Ä–º—ã –∑–∞–ø–∏—Å–∏ –∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–æ–π.
                </div>
            </div>
            {% endif %}

            {% if funnel.conversion_rates.booked_to_completed < 80 %}
            <div class="message-box message-bot" style="margin-bottom: 15px;">
                <div class="message-header">
                    <span><i class="fas fa-user-times"></i> –ö–ª–∏–µ–Ω—Ç—ã –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç</span>
                    <span class="badge badge-warning">–¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è</span>
                </div>
                <div class="message-text">
                    {{ 100 - funnel.conversion_rates.booked_to_completed | round }}% –∑–∞–ø–∏—Å–∞–≤—à–∏—Ö—Å—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç.
                    –î–æ–±–∞–≤—å—Ç–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø–µ—Ä–µ–¥ –≤–∏–∑–∏—Ç–æ–º –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –∑–∞ –¥–µ–Ω—å –¥–æ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã.
                </div>
            </div>
            {% endif %}

            {% if funnel.conversion_rates.visitor_to_engaged >= 70 and funnel.conversion_rates.engaged_to_booking >= 50 %}
            <div class="message-box" style="background: linear-gradient(135deg, #d1fae5, #a7f3d0); border-left: 5px solid #10b981;">
                <div class="message-header">
                    <span><i class="fas fa-check-circle"></i> –û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞!</span>
                    <span class="badge badge-success">–í—Å—ë —Ö–æ—Ä–æ—à–æ</span>
                </div>
                <div class="message-text">
                    –í–∞—à–∞ –≤–æ—Ä–æ–Ω–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—Ç–ª–∏—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã. –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ —Ä–µ–≥—É–ª—è—Ä–Ω–æ.
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="chart-container">
        <h2><i class="fas fa-chart-line"></i> –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏</h2>
        <div style="padding: 20px 0;">
            <div class="client-card">
                <div class="client-stats" style="border-top: none; padding-top: 0;">
                    <div class="client-stat">
                        <div class="client-stat-value">{{ ((funnel.completed / funnel.visitors * 100) if funnel.visitors > 0 else 0) | round(1) }}%</div>
                        <div class="client-stat-label">–û–±—â–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è</div>
                    </div>
                    <div class="client-stat">
                        <div class="client-stat-value">{{ funnel.visitors - funnel.completed }}</div>
                        <div class="client-stat-label">–ü–æ—Ç–µ—Ä—è–Ω–æ –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
                    </div>
                    <div class="client-stat">
                        <div class="client-stat-value">{{ ((funnel.completed / funnel.booked * 100) if funnel.booked > 0 else 0) | round(1) }}%</div>
                        <div class="client-stat-label">–Ø–≤–∫–∞ –Ω–∞ –≤–∏–∑–∏—Ç</div>
                    </div>
                </div>
            </div>

            <div class="client-card">
                <h3 style="margin-bottom: 15px; color: #1f2937;">–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª —Ä–æ—Å—Ç–∞</h3>
                <p style="color: #6b7280; margin-bottom: 20px;">
                    –ï—Å–ª–∏ —É–ª—É—á—à–∏—Ç—å –∫–∞–∂–¥—ã–π —ç—Ç–∞–ø –≤–æ—Ä–æ–Ω–∫–∏ –Ω–∞ 10%, –≤—ã –ø–æ–ª—É—á–∏—Ç–µ:
                </p>
                <div class="client-stats" style="border-top: none; padding-top: 0;">
                    <div class="client-stat">
                        <div class="client-stat-value" style="color: #10b981;">+{{ (funnel.visitors * 0.1) | round }}</div>
                        <div class="client-stat-label">–ë–æ–ª—å—à–µ –≤–æ–≤–ª–µ—á—ë–Ω–Ω—ã—Ö</div>
                    </div>
                    <div class="client-stat">
                        <div class="client-stat-value" style="color: #10b981;">+{{ (funnel.booked * 0.1) | round }}</div>
                        <div class="client-stat-label">–ë–æ–ª—å—à–µ –∑–∞–ø–∏—Å–µ–π</div>
                    </div>
                    <div class="client-stat">
                        <div class="client-stat-value" style="color: #10b981;">+{{ (funnel.completed * 0.1) | round }}</div>
                        <div class="client-stat-label">–ë–æ–ª—å—à–µ –≤–∏–∑–∏—Ç–æ–≤</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stage Details -->
<div class="data-table-container" style="margin-top: 30px;">
    <div style="padding: 20px; border-bottom: 1px solid #e5e7eb;">
        <h2 style="font-size: 1.3em; color: #1f2937;">
            <i class="fas fa-table"></i> –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —ç—Ç–∞–ø–∞–º
        </h2>
    </div>
    <table class="data-table">
        <thead>
            <tr>
                <th>–≠—Ç–∞–ø</th>
                <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                <th>–ö–æ–Ω–≤–µ—Ä—Å–∏—è</th>
                <th>–ü–æ—Ç–µ—Ä–∏</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><strong>–ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏</strong></td>
                <td>{{ funnel.visitors }}</td>
                <td>100%</td>
                <td>-</td>
                <td><span class="badge badge-info">–ù–∞—á–∞–ª–æ</span></td>
            </tr>
            <tr>
                <td><strong>–í–æ–≤–ª–µ—á—ë–Ω–Ω—ã–µ</strong></td>
                <td>{{ funnel.engaged }}</td>
                <td>{{ funnel.conversion_rates.visitor_to_engaged }}%</td>
                <td>{{ funnel.visitors - funnel.engaged }}</td>
                <td>
                    {% if funnel.conversion_rates.visitor_to_engaged >= 70 %}
                    <span class="badge badge-success">–û—Ç–ª–∏—á–Ω–æ</span>
                    {% elif funnel.conversion_rates.visitor_to_engaged >= 50 %}
                    <span class="badge badge-warning">–ù–æ—Ä–º–∞</span>
                    {% else %}
                    <span class="badge badge-danger">–ù–∏–∑–∫–æ</span>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td><strong>–ù–∞—á–∞–ª–∏ –∑–∞–ø–∏—Å—å</strong></td>
                <td>{{ funnel.started_booking }}</td>
                <td>{{ funnel.conversion_rates.engaged_to_booking }}%</td>
                <td>{{ funnel.engaged - funnel.started_booking }}</td>
                <td>
                    {% if funnel.conversion_rates.engaged_to_booking >= 60 %}
                    <span class="badge badge-success">–û—Ç–ª–∏—á–Ω–æ</span>
                    {% elif funnel.conversion_rates.engaged_to_booking >= 40 %}
                    <span class="badge badge-warning">–ù–æ—Ä–º–∞</span>
                    {% else %}
                    <span class="badge badge-danger">–ù–∏–∑–∫–æ</span>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td><strong>–ó–∞–ø–∏—Å–∞–ª–∏—Å—å</strong></td>
                <td>{{ funnel.booked }}</td>
                <td>{{ funnel.conversion_rates.booking_to_booked }}%</td>
                <td>{{ funnel.started_booking - funnel.booked }}</td>
                <td>
                    {% if funnel.conversion_rates.booking_to_booked >= 70 %}
                    <span class="badge badge-success">–û—Ç–ª–∏—á–Ω–æ</span>
                    {% elif funnel.conversion_rates.booking_to_booked >= 50 %}
                    <span class="badge badge-warning">–ù–æ—Ä–º–∞</span>
                    {% else %}
                    <span class="badge badge-danger">–ù–∏–∑–∫–æ</span>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td><strong>–ü–æ—Å–µ—Ç–∏–ª–∏</strong></td>
                <td>{{ funnel.completed }}</td>
                <td>{{ funnel.conversion_rates.booked_to_completed }}%</td>
                <td>{{ funnel.booked - funnel.completed }}</td>
                <td>
                    {% if funnel.conversion_rates.booked_to_completed >= 85 %}
                    <span class="badge badge-success">–û—Ç–ª–∏—á–Ω–æ</span>
                    {% elif funnel.conversion_rates.booked_to_completed >= 70 %}
                    <span class="badge badge-warning">–ù–æ—Ä–º–∞</span>
                    {% else %}
                    <span class="badge badge-danger">–ù–∏–∑–∫–æ</span>
                    {% endif %}
                </td>
            </tr>
        </tbody>
    </table>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function allowDrop(event) {
    event.preventDefault();
}

function drop(event, stage) {
    event.preventDefault();
    alert(`–≠–ª–µ–º–µ–Ω—Ç –ø–µ—Ä–µ–º–µ—â—ë–Ω –≤ —ç—Ç–∞–ø: ${stage}`);
}

function manageFunnel() {
    alert('–û—Ç–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–æ—Ä–æ–Ω–∫–∏ –ø—Ä–æ–¥–∞–∂');
}
</script>
{% endblock %}