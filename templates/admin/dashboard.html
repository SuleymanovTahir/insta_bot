{% extends "admin/base.html" %}

{% block title %}CRM Dashboard - {{ salon_info.name }}{% endblock %}

{% block nav_dashboard %}active{% endblock %}

{% block head_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üìä –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h1>
    <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ CRM-—Å–∏—Å—Ç–µ–º—É —Å–∞–ª–æ–Ω–∞ –∫—Ä–∞—Å–æ—Ç—ã</p>
</div>

<!-- Stats Grid -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-card-content">
            <div class="stat-card-info">
                <h3>{{ stats.total_clients }}</h3>
                <p>–í—Å–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–æ–≤</p>
                <span class="stat-trend trend-up">
                    <i class="fas fa-arrow-up"></i> +12%
                </span>
            </div>
            <div class="stat-card-icon">
                <i class="fas fa-users"></i>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-card-content">
            <div class="stat-card-info">
                <h3>{{ stats.total_bookings }}</h3>
                <p>–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</p>
                <span class="stat-trend trend-up">
                    <i class="fas fa-arrow-up"></i> +8%
                </span>
            </div>
            <div class="stat-card-icon">
                <i class="fas fa-calendar-check"></i>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-card-content">
            <div class="stat-card-info">
                <h3>{{ stats.completed_bookings }}</h3>
                <p>–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö</p>
                <span class="stat-trend trend-up">
                    <i class="fas fa-arrow-up"></i> +15%
                </span>
            </div>
            <div class="stat-card-icon">
                <i class="fas fa-check-circle"></i>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-card-content">
            <div class="stat-card-info">
                <h3>{{ stats.conversion_rate }}%</h3>
                <p>–ö–æ–Ω–≤–µ—Ä—Å–∏—è</p>
                <span class="stat-trend trend-up">
                    <i class="fas fa-arrow-up"></i> +3%
                </span>
            </div>
            <div class="stat-card-icon">
                <i class="fas fa-percentage"></i>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="analytics-grid">
    <!-- Bookings Chart -->
    <div class="chart-container">
        <h2><i class="fas fa-chart-line"></i> –ó–∞–ø–∏—Å–∏ –∑–∞ 30 –¥–Ω–µ–π</h2>
        <div class="chart-wrapper">
            <canvas id="bookingsChart"></canvas>
        </div>
    </div>

    <!-- Services Chart -->
    <div class="chart-container">
        <h2><i class="fas fa-chart-pie"></i> –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —É—Å–ª—É–≥–∏</h2>
        <div class="chart-wrapper">
            <canvas id="servicesChart"></canvas>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="analytics-grid">
    <!-- Recent Clients -->
    <div class="data-table-container">
        <div style="padding: 20px; border-bottom: 1px solid #e5e7eb;">
            <h2 style="font-size: 1.3em; color: #1f2937;">
                <i class="fas fa-user-plus"></i> –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—ã
            </h2>
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th>–ò–º—è</th>
                    <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–°–æ–æ–±—â–µ–Ω–∏–π</th>
                </tr>
            </thead>
            <tbody>
                {% for client in recent_clients %}
                <tr>
                    <td><strong>{{ client[3] or '–ù–µ —É–∫–∞–∑–∞–Ω–æ' }}</strong></td>
                    <td>{{ client[2] or '-' }}</td>
                    <td><span class="badge badge-{{ client[8] }}">{{ client[8] }}</span></td>
                    <td>{{ client[6] }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Recent Bookings -->
    <div class="data-table-container">
        <div style="padding: 20px; border-bottom: 1px solid #e5e7eb;">
            <h2 style="font-size: 1.3em; color: #1f2937;">
                <i class="fas fa-calendar-alt"></i> –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏
            </h2>
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th>–£—Å–ª—É–≥–∞</th>
                    <th>–ö–ª–∏–µ–Ω—Ç</th>
                    <th>–î–∞—Ç–∞</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                </tr>
            </thead>
            <tbody>
                {% for booking in recent_bookings %}
                <tr>
                    <td><strong>{{ booking[2] }}</strong></td>
                    <td>{{ booking[5] }}</td>
                    <td>{{ booking[3][:16] }}</td>
                    <td><span class="badge badge-{{ booking[6] }}">{{ booking[6] }}</span></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Quick Stats -->
<div class="stats-grid" style="margin-top: 30px;">
    <div class="stat-card">
        <div class="stat-card-content">
            <div class="stat-card-info">
                <h3>{{ stats.new_clients }}</h3>
                <p>–ù–æ–≤—ã–µ –∫–ª–∏–µ–Ω—Ç—ã</p>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 75%"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-card-content">
            <div class="stat-card-info">
                <h3>{{ stats.leads }}</h3>
                <p>–õ–∏–¥—ã</p>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 60%"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-card-content">
            <div class="stat-card-info">
                <h3>{{ stats.customers }}</h3>
                <p>–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã</p>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 85%"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-card-content">
            <div class="stat-card-info">
                <h3>{{ stats.pending_bookings }}</h3>
                <p>–û–∂–∏–¥–∞—é—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</p>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 45%"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Bookings Chart
const bookingsCtx = document.getElementById('bookingsChart').getContext('2d');
const bookingsChart = new Chart(bookingsCtx, {
    type: 'line',
    data: {
        labels: {{ analytics.bookings_by_day | map(attribute=0) | list | tojson }},
        datasets: [{
            label: '–ó–∞–ø–∏—Å–∏',
            data: {{ analytics.bookings_by_day | map(attribute=1) | list | tojson }},
            borderColor: 'rgb(102, 126, 234)',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Services Chart
const servicesCtx = document.getElementById('servicesChart').getContext('2d');
const servicesChart = new Chart(servicesCtx, {
    type: 'doughnut',
    data: {
        labels: {{ analytics.services_stats | map(attribute=0) | list | tojson }},
        datasets: [{
            data: {{ analytics.services_stats | map(attribute=1) | list | tojson }},
            backgroundColor: [
                'rgb(102, 126, 234)',
                'rgb(118, 75, 162)',
                'rgb(240, 147, 251)',
                'rgb(16, 185, 129)',
                'rgb(245, 158, 11)',
                'rgb(59, 130, 246)'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});
</script>
{% endblock %}