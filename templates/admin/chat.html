{% extends "admin/base.html" %}

{% block title %}–ß–∞—Ç —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏ - {{ salon_info.name }}{% endblock %}

{% block nav_chat %}active{% endblock %}

{% block extra_css %}
<style>
    /* –ì—Ä–∞–¥–∏–µ–Ω—Ç—ã –¥–ª—è —á–∞—Ç–∞ */
    .chat-gradient-bg {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .chat-header-glass {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ */
    .client-item {
        position: relative;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
    }

    .client-item::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 3px;
        background: linear-gradient(180deg, #667eea, #764ba2);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .client-item:hover {
        background: linear-gradient(90deg, rgba(102, 126, 234, 0.05), transparent);
        transform: translateX(2px);
    }

    .client-item:hover::before {
        opacity: 1;
    }

    .client-item.active {
        background: linear-gradient(90deg, rgba(102, 126, 234, 0.1), transparent);
        border-left: 3px solid #667eea;
    }

    .client-item.pinned {
        background: linear-gradient(90deg, rgba(245, 158, 11, 0.05), transparent);
        border-left: 3px solid #f59e0b;
    }

    /* –°—Ç–∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–π */
    .chat-message {
        animation: messageSlideIn 0.3s ease-out;
    }

    @keyframes messageSlideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message-bubble {
        position: relative;
        max-width: 70%;
        word-wrap: break-word;
        transition: all 0.2s ease;
    }

    .message-bubble:hover {
        transform: scale(1.02);
    }

    .incoming .message-bubble {
        background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
        border-radius: 18px 18px 18px 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .outgoing .message-bubble {
        background: linear-gradient(135deg, #667eea, #764ba2);
        border-radius: 18px 18px 4px 18px;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        color: white;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª—è –≤–≤–æ–¥–∞ */
    .chat-input-container {
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(10px);
        border-top: 1px solid rgba(0, 0, 0, 0.05);
        box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.05);
    }

    .chat-input {
        border: 2px solid transparent;
        background: #f3f4f6;
        transition: all 0.3s ease;
        border-radius: 24px;
        padding: 12px 20px;
    }

    .chat-input:focus {
        border-color: #667eea;
        background: white;
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    .btn-send {
        background: linear-gradient(135deg, #667eea, #764ba2);
        transition: all 0.3s ease;
        border-radius: 50%;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-send:hover {
        transform: scale(1.1) rotate(15deg);
        box-shadow: 0 8px 16px rgba(102, 126, 234, 0.4);
    }

    .btn-icon {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.3s ease;
        background: #f3f4f6;
    }

    .btn-icon:hover {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        transform: scale(1.1);
    }

    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏ */
    #typingIndicator {
        animation: pulse 1.5s ease-in-out infinite;
    }

    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
    .image-modal {
        z-index: 9999;
        display: none;
    }

    .image-modal.active {
        display: flex;
    }

    .image-modal-content {
        animation: zoomIn 0.3s ease-out;
    }

    @keyframes zoomIn {
        from {
            transform: scale(0.8);
            opacity: 0;
        }
        to {
            transform: scale(1);
            opacity: 1;
        }
    }

    /* –ê—É–¥–∏–æ –ø–ª–µ–µ—Ä */
    .audio-play-btn {
        transition: all 0.3s ease;
    }

    .audio-play-btn:hover {
        transform: scale(1.2);
    }

    .audio-waveform {
        background: linear-gradient(90deg, #e5e7eb, #d1d5db);
        border-radius: 4px;
        position: relative;
        overflow: hidden;
    }

    .audio-waveform.playing::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: 100%;
        background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.3), transparent);
        animation: waveAnimation 1.5s linear infinite;
    }

    @keyframes waveAnimation {
        from { transform: translateX(-100%); }
        to { transform: translateX(100%); }
    }

    /* –ü–∞–Ω–µ–ª—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ */
    .info-panel {
        transition: all 0.3s ease;
        transform: translateX(0);
    }

    .info-panel.hidden {
        transform: translateX(100%);
    }

    /* Badge —Å—Ç–∏–ª–∏ */
    .badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .badge-new { background: linear-gradient(135deg, #10b981, #059669); color: white; }
    .badge-lead { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; }
    .badge-customer { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; }
    .badge-vip { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
    .badge-blocked { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }

    /* –°–∫—Ä–æ–ª–ª –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π */
    #chatMessages::-webkit-scrollbar {
        width: 8px;
    }

    #chatMessages::-webkit-scrollbar-track {
        background: transparent;
    }

    #chatMessages::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, #667eea, #764ba2);
        border-radius: 4px;
    }

    /* –ü–æ–∏—Å–∫ */
    #chatSearch {
        transition: all 0.3s ease;
        border-radius: 12px;
    }

    #chatSearch:focus {
        transform: scale(1.02);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }
</style>
{% endblock %}

{% block content %}
<div class="flex h-[calc(100vh-2rem)] gap-0 rounded-2xl overflow-hidden shadow-2xl">
    <!-- –°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ -->
    <div class="w-80 bg-white flex flex-col">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–ø–∏—Å–∫–∞ -->
        <div class="p-4 chat-header-glass">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                    <span class="w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-indigo-600 flex items-center justify-center">
                        <i class="fas fa-comments text-white text-sm"></i>
                    </span>
                    –ß–∞—Ç—ã
                </h3>
                {% if unread_count > 0 %}
                <span class="notification-badge bg-gradient-to-r from-red-500 to-pink-600 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg" 
                      id="totalUnreadBadge">
                    {{ unread_count }}
                </span>
                {% endif %}
            </div>
            <div class="relative">
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                <input type="text" 
                       class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent" 
                       placeholder="üîç –ü–æ–∏—Å–∫..." 
                       onkeyup="searchChats()" 
                       id="chatSearch">
            </div>
        </div>
        
        <!-- –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ -->
        <div class="flex-1 overflow-y-auto" id="clientsList">
            {% if chats %}
            {% for chat in chats %}
            <div class="client-item p-4 border-b border-gray-100 {% if active_client == chat.instagram_id %}active{% endif %} {% if chat.is_pinned %}pinned{% endif %}"
                 onclick="openChat('{{ chat.instagram_id }}')"
                 data-client-id="{{ chat.instagram_id }}"
                 data-name="{{ chat.name or chat.username or '–ö–ª–∏–µ–Ω—Ç' }}"
                 data-username="{{ chat.username or '' }}">
                <div class="flex items-center gap-3">
                    <!-- –ê–≤–∞—Ç–∞—Ä -->
                    <div class="relative">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-400 to-pink-600 flex items-center justify-center overflow-hidden shadow-lg">
                            {% if chat.profile_pic %}
                            <img src="{{ chat.profile_pic }}" alt="{{ chat.name }}"
                                 class="w-full h-full object-cover">
                            {% else %}
                            <span class="text-white font-bold text-lg">
                                {{ chat.name[0] if chat.name else chat.username[0] if chat.username else '?' }}
                            </span>
                            {% endif %}
                        </div>
                        {% if chat.unread_count > 0 %}
                        <span class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full flex items-center justify-center text-white text-xs font-bold shadow-lg">
                            {{ chat.unread_count }}
                        </span>
                        {% endif %}
                    </div>
                    
                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-sm font-semibold text-gray-900 truncate flex items-center gap-1">
                                {% if chat.is_pinned %}
                                <i class="fas fa-thumbtack text-amber-500"></i>
                                {% endif %}
                                {{ chat.display_name }}
                            </span>
                            <span class="text-xs text-gray-500" data-time="{{ chat.last_message_time }}">
                                {{ chat.last_message_time }}
                            </span>
                        </div>
                        <div class="text-xs text-gray-600 truncate mb-1" data-last-message>
                            {{ chat.last_message[:40] }}...
                        </div>
                        <div class="flex justify-between items-center">
                            {% if chat.instagram_url %}
                            <a href="{{ chat.instagram_url }}" target="_blank" 
                               onclick="event.stopPropagation();" 
                               class="text-xs text-indigo-600 hover:text-indigo-800 flex items-center gap-1">
                                <i class="fab fa-instagram"></i>
                                @{{ chat.username }}
                            </a>
                            {% else %}
                            <span class="text-xs text-gray-400">{{ chat.instagram_id[:15] }}...</span>
                            {% endif %}
                            <span class="badge badge-{{ chat.status }}">
                                {{ client_statuses[chat.status].label if chat.status in client_statuses else chat.status }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="p-8 text-center text-gray-500">
                <i class="fas fa-comments text-6xl opacity-20 mb-4"></i>
                <p class="font-medium">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤</p>
                <p class="text-sm mt-2">–ß–∞—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- –û–±–ª–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π -->
    <div class="flex-1 flex flex-col bg-white">
        {% if active_client %}
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ -->
        <div class="p-4 chat-header-glass">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-400 to-pink-600 flex items-center justify-center overflow-hidden shadow-lg">
                        {% if active_client_info.profile_pic %}
                        <img src="{{ active_client_info.profile_pic }}" 
                             alt="{{ active_client_info.name }}" 
                             class="w-full h-full object-cover">
                        {% else %}
                        <span class="text-white font-bold">
                            {{ active_client_info.name[0] if active_client_info.name else '?' }}
                        </span>
                        {% endif %}
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                            {{ active_client_info.name or active_client_info.username or '–ö–ª–∏–µ–Ω—Ç' }}
                            <button class="text-gray-400 hover:text-amber-500 transition-colors" 
                                    onclick="pinClient('{{ active_client }}')" 
                                    title="–ó–∞–∫—Ä–µ–ø–∏—Ç—å">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                        </h3>
                        <div class="flex items-center gap-2 text-sm text-gray-600">
                            {% if active_client_info.phone %}
                            <span><i class="fas fa-phone"></i> {{ active_client_info.phone }}</span>
                            {% endif %}
                            {% if active_client_info.instagram_url %}
                            <a href="{{ active_client_info.instagram_url }}" 
                               target="_blank" 
                               class="text-indigo-600 hover:text-indigo-800">
                                <i class="fab fa-instagram"></i> @{{ active_client_info.username }}
                            </a>
                            {% endif %}
                        </div>
                        <p id="typingIndicator" class="text-sm text-green-500 hidden">
                            <i class="fas fa-circle text-xs animate-pulse"></i> –ü–µ—á–∞—Ç–∞–µ—Ç...
                        </p>
                    </div>
                </div>
                <button class="px-4 py-2 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-xl hover:shadow-lg transition-all" 
                        onclick="toggleClientInfo()" 
                        id="toggleInfoBtn">
                    <i class="fas fa-info-circle mr-2"></i> –ò–Ω—Ñ–æ
                </button>
            </div>
        </div>
        
        <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
        <div class="flex-1 overflow-y-auto p-6 space-y-4 bg-gradient-to-br from-gray-50 to-white" 
             id="chatMessages">
            {% for message in messages %}
            <div class="chat-message flex {% if message.sender == 'client' %}justify-start{% else %}justify-end{% endif %}" 
                 data-message-id="{{ loop.index }}">
                <div class="message-bubble p-4">
                    <div class="message-content">
                        {% if message.type == 'voice' %}
                        {% set voice_parts = message.message.split('|') %}
                        {% if voice_parts|length >= 2 %}
                        {% set duration = voice_parts[0].replace('üé§', '').replace('s', '').strip() %}
                        {% set filename = voice_parts[1].strip() %}
                        <div class="flex items-center gap-3">
                            <button class="audio-play-btn text-white" 
                                    onclick="playVoiceMessage('/admin/api/uploads/voice/{{ filename }}', this)">
                                <i class="fas fa-play"></i>
                            </button>
                            <div class="audio-waveform h-6 flex-1 max-w-[200px]"></div>
                            <span class="audio-duration text-xs opacity-80">{{ duration }}s</span>
                        </div>
                        {% else %}
                        {{ message.message }}
                        {% endif %}
                        {% elif message.type == 'image' %}
                        {% set filename = message.message.replace('üñºÔ∏è', '').strip() %}
                        <div class="cursor-pointer" onclick="openImageModal('/admin/api/uploads/images/{{ filename }}')">
                            <img src="/admin/api/uploads/images/{{ filename }}" 
                                 alt="Image" 
                                 class="max-w-full rounded-lg shadow-lg hover:shadow-xl transition-shadow"
                                 onerror="this.parentElement.innerHTML='<div class=&quot;p-4 text-center text-red-500&quot;><i class=&quot;fas fa-exclamation-triangle&quot;></i><br>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>'">
                        </div>
                        {% elif message.type == 'file' %}
                        {% set filename = message.message.replace('üìé', '').strip() %}
                        <a href="/admin/api/uploads/files/{{ filename }}" 
                           class="flex items-center gap-2 hover:opacity-80 transition-opacity" 
                           download>
                            <i class="fas fa-file-alt text-2xl"></i>
                            <span class="text-sm">{{ filename[:30] }}{% if filename|length > 30 %}...{% endif %}</span>
                            <i class="fas fa-download"></i>
                        </a>
                        {% else %}
                        {{ message.message }}
                        {% endif %}
                    </div>
                    <div class="flex items-center gap-2 mt-2 text-xs {% if message.sender == 'bot' %}text-white/70{% else %}text-gray-500{% endif %}">
                        <span>{{ message.timestamp[11:16] }}</span>
                        {% if message.sender == 'bot' %}
                        <i class="fas fa-check-double"></i>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ -->
        <div class="chat-input-container p-4">
            <div class="flex items-center gap-2">
                <button class="btn-icon" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ" onclick="attachImage()">
                    <i class="fas fa-image"></i>
                </button>
                <button class="btn-icon" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª" onclick="attachFile()">
                    <i class="fas fa-paperclip"></i>
                </button>
                <button class="btn-icon" id="voiceBtn" title="–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" onclick="recordVoice()">
                    <i class="fas fa-microphone"></i>
                </button>
                <textarea class="flex-1 chat-input resize-none" 
                          id="messageInput" 
                          placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                          rows="1" 
                          oninput="handleTyping()" 
                          onkeypress="handleKeyPress(event)"></textarea>
                <button class="btn-send" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            <input type="file" id="fileInput" style="display: none;" accept=".pdf,.doc,.docx,.txt,.zip,.rar" onchange="handleFileSelect(event, false)">
            <input type="file" id="imageInput" style="display: none;" accept="image/*" onchange="handleFileSelect(event, true)">
        </div>
        
        <!-- –ú–æ–¥–∞–ª –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–∞—Ä—Ç–∏–Ω–æ–∫ -->
        <div class="image-modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center" 
             id="imageModal" 
             onclick="closeImageModal()">
            <button class="absolute top-4 right-4 text-white text-4xl hover:scale-110 transition-transform" 
                    onclick="closeImageModal()">
                &times;
            </button>
            <img class="image-modal-content max-w-[90%] max-h-[90%] rounded-2xl shadow-2xl" 
                 id="modalImage">
        </div>
        {% else %}
        <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
        <div class="flex-1 flex items-center justify-center">
            <div class="text-center">
                <div class="w-32 h-32 mx-auto mb-6 rounded-full bg-gradient-to-br from-purple-400 to-pink-600 flex items-center justify-center">
                    <i class="fas fa-comment-dots text-6xl text-white"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-900 mb-2">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
                <p class="text-gray-500">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞ –¥–ª—è –Ω–∞—á–∞–ª–∞ –æ–±—â–µ–Ω–∏—è</p>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- –ü–∞–Ω–µ–ª—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–ª–∏–µ–Ω—Ç–µ -->
    {% if active_client_info %}
    <div class="w-80 bg-white border-l border-gray-200 flex-col info-panel" id="clientInfoPanel">
        <div class="p-4 chat-header-glass flex justify-between items-center">
            <h3 class="text-lg font-bold text-gray-900">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
            <button class="text-gray-500 hover:text-red-500 transition-colors" onclick="toggleClientInfo()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-4 flex-1 overflow-y-auto">
            <div class="text-center mb-6">
                <div class="w-20 h-20 rounded-full bg-gradient-to-br from-purple-400 to-pink-600 flex items-center justify-center overflow-hidden mx-auto shadow-xl mb-3">
                    {% if active_client_info.profile_pic %}
                    <img src="{{ active_client_info.profile_pic }}" alt="{{ active_client_info.name }}" class="w-full h-full object-cover">
                    {% else %}
                    <span class="text-white font-bold text-2xl">{{ active_client_info.name[0] if active_client_info.name else '?' }}</span>
                    {% endif %}
                </div>
                <h3 contenteditable="true" 
                    id="clientName" 
                    onblur="updateClientField('name', this.textContent)" 
                    class="text-xl font-bold text-gray-900 hover:text-purple-600 transition-colors">
                    {{ active_client_info.name or '–ö–ª–∏–µ–Ω—Ç' }}
                </h3>
                <p class="text-sm text-gray-500">@{{ active_client_info.username or active_client_info.instagram_id[:15] }}</p>
            </div>
            
            <div class="space-y-6">
                <!-- –ö–æ–Ω—Ç–∞–∫—Ç—ã -->
                <div class="bg-gradient-to-br from-purple-50 to-pink-50 p-4 rounded-xl">
                    <h4 class="text-sm font-bold text-gray-900 mb-3 flex items-center gap-2">
                        <i class="fas fa-user text-purple-600"></i> –ö–æ–Ω—Ç–∞–∫—Ç—ã
                    </h4>
                    <div class="space-y-2">
                        <input type="text" 
                               class="w-full p-2 border border-purple-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white" 
                               id="clientPhone" 
                               value="{{ active_client_info.phone or '' }}" 
                               placeholder="–¢–µ–ª–µ—Ñ–æ–Ω"
                               onblur="updateClientField('phone', this.value)">
                        {% if active_client_info.instagram_url %}
                        <a href="{{ active_client_info.instagram_url }}" 
                           target="_blank" 
                           class="block text-sm text-indigo-600 hover:text-indigo-800">
                            <i class="fab fa-instagram"></i> @{{ active_client_info.username }}
                        </a>
                        {% endif %}
                    </div>
                </div>
                
                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                <div class="bg-gradient-to-br from-blue-50 to-cyan-50 p-4 rounded-xl">
                    <h4 class="text-sm font-bold text-gray-900 mb-3 flex items-center gap-2">
                        <i class="fas fa-chart-line text-blue-600"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                    </h4>
                    <div class="space-y-3">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">–°–æ–æ–±—â–µ–Ω–∏–π</span>
                            <span class="font-bold text-blue-600">{{ active_client_info.total_messages }}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">LTV</span>
                            <span class="font-bold text-green-600">{{ active_client_info.lifetime_value }} AED</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">–ü–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç</span>
                            <span class="font-medium">{{ active_client_info.first_contact[:10] }}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">–ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–Ω—Ç–∞–∫—Ç</span>
                            <span class="font-medium">{{ active_client_info.last_contact[:10] }}</span>
                        </div>
                    </div>
                </div>
                
                <!-- –°—Ç–∞—Ç—É—Å -->
                <div>
                    <h4 class="text-sm font-bold text-gray-900 mb-2 flex items-center gap-2">
                        <i class="fas fa-tag text-purple-600"></i> –°—Ç–∞—Ç—É—Å
                    </h4>
                    <select class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            id="clientStatus" 
                            onchange="updateClientStatus(this.value)">
                        {% for key, status in client_statuses.items() %}
                        <option value="{{ key }}" {% if active_client_info.status==key %}selected{% endif %}>
                            {{ status.label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- –ó–∞–º–µ—Ç–∫–∏ -->
                <div>
                    <h4 class="text-sm font-bold text-gray-900 mb-2 flex items-center gap-2">
                        <i class="fas fa-sticky-note text-yellow-600"></i> –ó–∞–º–µ—Ç–∫–∏
                    </h4>
                    <textarea class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"
                              id="clientNotes" 
                              rows="4"
                              placeholder="–î–æ–±–∞–≤—å—Ç–µ –∑–∞–º–µ—Ç–∫–∏ –æ –∫–ª–∏–µ–Ω—Ç–µ..." 
                              onblur="saveNotes()">{{ active_client_info.notes or '' }}</textarea>
                </div>
                
                <!-- –î–µ–π—Å—Ç–≤–∏—è -->
                <div>
                    <button class="w-full bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 text-white px-4 py-3 rounded-xl flex items-center justify-center gap-2 transition-all hover:shadow-lg"
                            onclick="blockClient()">
                        <i class="fas fa-ban"></i> –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    const activeClient = '{{ active_client }}';
    let lastMessageCount = {{ messages| length if messages else 0 }};
    let isAutoScrollEnabled = true;
    let typingTimeout;

    // ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =====
    document.addEventListener('DOMContentLoaded', function () {
        console.log('üü¢ –ß–∞—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–∞ –Ω–∞ –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∫–ª–∏–µ–Ω—Ç–æ–≤
        document.querySelectorAll('.client-item').forEach(item => {
            const clientId = item.getAttribute('data-client-id');
            if (clientId) {
                item.addEventListener('click', function (e) {
                    if (e.target.tagName === 'A' || e.target.closest('a')) {
                        return;
                    }
                    openChat(clientId);
                });
            }
        });

        // –ê–≤—Ç–æ-—Å–∫—Ä–æ–ª–ª –≤–Ω–∏–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        if (activeClient) {
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                setTimeout(() => {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 100);
            }
            
            // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
            const input = document.getElementById('messageInput');
            if (input) {
                input.focus();
            }
        }
    });

    // ===== –§–£–ù–ö–¶–ò–Ø –û–¢–ö–†–´–¢–ò–Ø –ß–ê–¢–ê =====
    function openChat(clientId) {
        if (!clientId || activeClient === clientId) return;
        window.location.href = `/admin/chat?client=${clientId}`;
    }

    // ===== –ü–û–ò–°–ö –ß–ê–¢–û–í =====
    function searchChats() {
        const input = document.getElementById('chatSearch');
        const filter = input.value.toUpperCase();
        const items = document.querySelectorAll('.client-item');

        items.forEach(item => {
            const text = item.textContent || item.innerText;
            item.style.display = text.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
        });
    }

    // ===== –û–ë–†–ê–ë–û–¢–ö–ê ENTER =====
    function handleKeyPress(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    }

    // ===== –ê–í–¢–û-–†–ï–°–ê–ô–ó TEXTAREA =====
    const messageInput = document.getElementById('messageInput');
    if (messageInput) {
        messageInput.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
    }

    // ===== –ò–ù–î–ò–ö–ê–¢–û–† –ü–ï–ß–ê–¢–ò =====
    function handleTyping() {
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            // –ö–ª–∏–µ–Ω—Ç –ø–µ—Ä–µ—Å—Ç–∞–ª –ø–µ—á–∞—Ç–∞—Ç—å
        }, 1000);
    }

    // ===== –í–û–°–ü–†–û–ò–ó–í–ï–î–ï–ù–ò–ï –ì–û–õ–û–°–û–í–´–• –°–û–û–ë–©–ï–ù–ò–ô =====
    let currentAudio = null;
    let currentButton = null;

    function playVoiceMessage(filePath, button) {
        const icon = button.querySelector('i');
        const waveform = button.parentElement.querySelector('.audio-waveform');
        const durationSpan = button.parentElement.querySelector('.audio-duration');

        if (currentAudio && !currentAudio.paused && currentButton === button) {
            currentAudio.pause();
            icon.className = 'fas fa-play';
            button.classList.remove('playing');
            waveform.classList.remove('playing');
        } else {
            if (currentAudio) {
                currentAudio.pause();
                if (currentButton) {
                    currentButton.querySelector('i').className = 'fas fa-play';
                    currentButton.classList.remove('playing');
                    const prevWave = currentButton.parentElement.querySelector('.audio-waveform');
                    if (prevWave) prevWave.classList.remove('playing');
                }
            }

            currentAudio = new Audio(filePath);
            currentButton = button;

            currentAudio.addEventListener('loadedmetadata', () => {
                const totalDuration = Math.floor(currentAudio.duration);
                durationSpan.textContent = totalDuration + 's';
            });

            currentAudio.addEventListener('timeupdate', () => {
                const remaining = Math.ceil(currentAudio.duration - currentAudio.currentTime);
                durationSpan.textContent = remaining + 's';
            });

            currentAudio.play();
            icon.className = 'fas fa-pause';
            button.classList.add('playing');
            waveform.classList.add('playing');

            currentAudio.onended = () => {
                icon.className = 'fas fa-play';
                button.classList.remove('playing');
                waveform.classList.remove('playing');
                currentButton = null;
            };

            currentAudio.onerror = () => {
                showNotification('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∞—É–¥–∏–æ', 'error');
                icon.className = 'fas fa-play';
                button.classList.remove('playing');
                waveform.classList.remove('playing');
            };
        }
    }

    // ===== –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–Ø =====
    async function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();

        if (!message || !activeClient) return;

        const sendBtn = document.querySelector('.btn-send');
        sendBtn.disabled = true;
        sendBtn.style.opacity = '0.6';

        try {
            const response = await fetch('/admin/api/chat/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    instagram_id: activeClient,
                    message: message
                })
            });

            const data = await response.json();

            if (data.success) {
                input.value = '';
                input.style.height = 'auto';
                await loadMessages();
                showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
            } else {
                showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏', 'error');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
        } finally {
            sendBtn.disabled = false;
            sendBtn.style.opacity = '1';
            input.focus();
        }
    }

    // ===== –ó–ê–ì–†–£–ó–ö–ê –°–û–û–ë–©–ï–ù–ò–ô =====
    async function loadMessages() {
        if (!activeClient) return;

        try {
            const response = await fetch(`/admin/api/chat/messages?client=${activeClient}`);
            const data = await response.json();

            if (data.messages && data.messages.length !== lastMessageCount) {
                const container = document.getElementById('chatMessages');
                const wasScrolledToBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 50;

                container.innerHTML = '';

                data.messages.forEach((msg, index) => {
                    const div = createMessageElement(msg, index);
                    container.appendChild(div);
                });

                if (wasScrolledToBottom || (data.messages.length > 0 && data.messages[data.messages.length - 1].sender === 'client')) {
                    container.scrollTop = container.scrollHeight;
                }

                lastMessageCount = data.messages.length;
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
        }
    }

    // ===== –°–û–ó–î–ê–ù–ò–ï –≠–õ–ï–ú–ï–ù–¢–ê –°–û–û–ë–©–ï–ù–ò–Ø =====
    function createMessageElement(msg, index) {
        const div = document.createElement('div');
        div.className = `chat-message flex ${msg.sender === 'client' ? 'justify-start' : 'justify-end'}`;
        div.setAttribute('data-message-id', index);

        let contentHtml = '';
        const messageText = msg.message || '';

        if (msg.type === 'voice' || messageText.includes('üé§')) {
            const match = messageText.match(/üé§\s*(\d+)s\|(.+)/);
            const duration = match ? match[1] : '0';
            const filename = match ? match[2].trim() : '';

            if (filename) {
                contentHtml = `
                    <div class="flex items-center gap-3">
                        <button class="audio-play-btn ${msg.sender === 'bot' ? 'text-white' : 'text-indigo-600'}" onclick="playVoiceMessage('/admin/api/uploads/voice/${filename}', this)">
                            <i class="fas fa-play"></i>
                        </button>
                        <div class="audio-waveform h-6 flex-1 max-w-[200px]"></div>
                        <span class="audio-duration text-xs opacity-80">${duration}s</span>
                    </div>
                `;
            } else {
                contentHtml = escapeHtml(messageText);
            }
        } else if (msg.type === 'image' || messageText.includes('üñºÔ∏è')) {
            const filename = messageText.includes(': ') ? messageText.split(': ')[1].trim() : '';
            if (filename) {
                contentHtml = `
                    <div class="cursor-pointer" onclick="openImageModal('/admin/api/uploads/images/${filename}')">
                        <img src="/admin/api/uploads/images/${filename}" alt="Image" class="max-w-full rounded-lg shadow-lg hover:shadow-xl transition-shadow" 
                             onerror="this.parentElement.innerHTML='<div class=&quot;p-4 text-center text-red-500&quot;><i class=&quot;fas fa-exclamation-triangle&quot;></i><br>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>'">
                    </div>
                `;
            } else {
                contentHtml = escapeHtml(messageText);
            }
        } else if (msg.type === 'file' || messageText.includes('üìé')) {
            const fileName = messageText.includes(': ') ? messageText.split(': ')[1].trim() : '–§–∞–π–ª';
            if (fileName && fileName !== '–§–∞–π–ª') {
                contentHtml = `
                    <a href="/admin/api/uploads/files/${fileName}" class="flex items-center gap-2 hover:opacity-80 transition-opacity" download>
                        <i class="fas fa-file-alt text-2xl"></i>
                        <span class="text-sm">${escapeHtml(fileName.length > 30 ? fileName.substring(0, 27) + '...' : fileName)}</span>
                        <i class="fas fa-download"></i>
                    </a>
                `;
            } else {
                contentHtml = escapeHtml(messageText);
            }
        } else {
            contentHtml = escapeHtml(messageText);
        }

        div.innerHTML = `
            <div class="message-bubble p-4">
                <div class="message-content">
                    ${contentHtml}
                </div>
                <div class="flex items-center gap-2 mt-2 text-xs ${msg.sender === 'bot' ? 'text-white/70' : 'text-gray-500'}">
                    <span>${msg.timestamp.substring(11, 16)}</span>
                    ${msg.sender === 'bot' ? '<i class="fas fa-check-double"></i>' : ''}
                </div>
            </div>
        `;

        return div;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ===== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–ê–ù–ï–õ–¨–Æ –ò–ù–§–û–†–ú–ê–¶–ò–ò =====
    function toggleClientInfo() {
        const panel = document.getElementById('clientInfoPanel');
        if (panel) {
            panel.classList.toggle('hidden');
        }
    }

    // ===== –û–ë–ù–û–í–õ–ï–ù–ò–ï –î–ê–ù–ù–´–• –ö–õ–ò–ï–ù–¢–ê =====
    async function updateClientStatus(status) {
        try {
            const response = await fetch(`/admin/api/clients/${activeClient}/status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: status })
            });

            const data = await response.json();
            if (data.success) {
                showNotification('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è', 'error');
        }
    }

    async function updateClientField(field, value) {
        if (!activeClient || !value) return;

        try {
            const response = await fetch(`/admin/api/clients/${activeClient}/update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ [field]: value })
            });

            const data = await response.json();
            if (data.success) {
                showNotification('–û–±–Ω–æ–≤–ª–µ–Ω–æ', 'success');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è', 'error');
        }
    }

    async function saveNotes() {
        if (!activeClient) return;

        const notes = document.getElementById('clientNotes').value;

        try {
            const response = await fetch(`/admin/api/clients/${activeClient}/notes`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ notes: notes })
            });

            const data = await response.json();
            if (data.success) {
                showNotification('–ó–∞–º–µ—Ç–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
        }
    }

    async function pinClient(clientId) {
        try {
            const response = await fetch(`/admin/api/clients/${clientId}/pin`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const data = await response.json();
            if (data.success) {
                showNotification(data.pinned ? '–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–æ' : '–û—Ç–∫—Ä–µ–ø–ª–µ–Ω–æ', 'success');
                location.reload();
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞', 'error');
        }
    }

    function blockClient() {
        if (confirm('–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞?')) {
            updateClientStatus('blocked');
        }
    }

    // ===== –†–ê–ë–û–¢–ê –° –§–ê–ô–õ–ê–ú–ò =====
    function attachFile() {
        document.getElementById('fileInput').click();
    }

    function attachImage() {
        document.getElementById('imageInput').click();
    }

    async function handleFileSelect(event, isImage) {
        const file = event.target.files[0];
        if (!file) return;

        if (file.size > 10 * 1024 * 1024) {
            showNotification('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å 10MB)', 'error');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);
        formData.append('instagram_id', activeClient);
        formData.append('is_image', isImage);

        try {
            showNotification(isImage ? '–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏...' : '–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞...', 'info');

            const response = await fetch('/admin/api/chat/upload', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                showNotification(isImage ? '–ö–∞—Ä—Ç–∏–Ω–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞' : '–§–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'success');
                await loadMessages();
            } else {
                showNotification(data.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', 'error');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', 'error');
        }

        event.target.value = '';
    }

    // ===== –ì–û–õ–û–°–û–í–´–ï –°–û–û–ë–©–ï–ù–ò–Ø =====
    let mediaRecorder;
    let audioChunks = [];

    async function recordVoice() {
        const recordBtn = event.target.closest('.btn-icon');

        if (!mediaRecorder || mediaRecorder.state === 'inactive') {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await sendVoiceMessage(audioBlob);
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                recordBtn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                recordBtn.querySelector('i').className = 'fas fa-stop';
                showNotification('–ó–∞–ø–∏—Å—å –Ω–∞—á–∞–ª–∞—Å—å...', 'info');
            } catch (error) {
                showNotification('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É', 'error');
            }
        } else {
            mediaRecorder.stop();
            recordBtn.style.background = '';
            recordBtn.querySelector('i').className = 'fas fa-microphone';
        }
    }

    async function sendVoiceMessage(audioBlob) {
        const formData = new FormData();
        formData.append('voice', audioBlob, 'voice.webm');
        formData.append('instagram_id', activeClient);
        
        const duration = Math.round(audioBlob.size / 16000);
        formData.append('duration', duration.toString());

        try {
            showNotification('–û—Ç–ø—Ä–∞–≤–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ...', 'info');

            const response = await fetch('/admin/api/chat/voice', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                showNotification('–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
                await loadMessages();
            } else {
                showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + (data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ', 'error');
        }
    }

    // ===== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –î–õ–Ø –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô =====
    function openImageModal(src) {
        const modal = document.getElementById('imageModal');
        const img = document.getElementById('modalImage');
        modal.classList.add('active');
        img.src = src;
        document.addEventListener('keydown', closeOnEscape);
    }

    function closeImageModal() {
        document.getElementById('imageModal').classList.remove('active');
        document.removeEventListener('keydown', closeOnEscape);
    }

    function closeOnEscape(e) {
        if (e.key === 'Escape') {
            closeImageModal();
        }
    }

    // ===== –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–ü–ò–°–ö–ê –ß–ê–¢–û–í =====
    async function updateChatsList() {
        try {
            const response = await fetch('/admin/api/chats-update');
            const data = await response.json();

            if (data.chats) {
                data.chats.forEach(chat => {
                    const clientItem = document.querySelector(`[data-client-id="${chat.instagram_id}"]`);
                    if (clientItem) {
                        const lastMessageEl = clientItem.querySelector('[data-last-message]');
                        if (lastMessageEl && chat.last_message) {
                            lastMessageEl.textContent = chat.last_message.substring(0, 40) + '...';
                        }

                        const timeEl = clientItem.querySelector('[data-time]');
                        if (timeEl && chat.last_message_time) {
                            timeEl.textContent = chat.last_message_time;
                        }
                    }
                });

                const totalBadge = document.getElementById('totalUnreadBadge');
                if (data.total_unread > 0) {
                    if (totalBadge) {
                        totalBadge.textContent = data.total_unread;
                    }
                } else if (totalBadge) {
                    totalBadge.remove();
                }
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤:', error);
        }
    }

    // ===== –ü–ï–†–ò–û–î–ò–ß–ï–°–ö–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï =====
    if (activeClient) {
        setInterval(loadMessages, 3000);
        setInterval(updateChatsList, 5000);
    }
</script>
{% endblock %}