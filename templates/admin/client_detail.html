{% extends "admin/base.html" %}

{% block title %}{{ client[3] or 'Клиент' }} - {{ salon_info.name }}{% endblock %}

{% block nav_clients %}active{% endblock %}

{% block content %}
<!-- Back Button & Header -->
<div style="margin-bottom: 2rem;">
    <a href="/admin/clients" style="display: inline-flex; align-items: center; gap: 0.5rem; color: #ec4899; text-decoration: none; font-weight: 500; margin-bottom: 1rem; transition: all 0.2s;">
        <i class="fas fa-arrow-left"></i>
        <span>Назад к списку</span>
    </a>
    
    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <div style="width: 64px; height: 64px; border-radius: 16px; background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 2rem; box-shadow: 0 4px 12px rgba(236, 72, 153, 0.3);">
                {{ client[3][0] if client[3] else '?' }}
            </div>
            <div>
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.25rem;">
                    <h1 style="font-size: 2rem; font-weight: 700; color: #111827; margin: 0;">
                        {{ client[3] or 'Клиент' }}
                    </h1>
                    {% if client[8] == 'vip' %}
                    <span class="badge" style="background: #f3e8ff; color: #7c3aed; font-size: 0.875rem;">
                        <i class="fas fa-crown"></i> VIP
                    </span>
                    {% elif client[8] == 'regular' %}
                    <span class="badge" style="background: #dbeafe; color: #1e40af; font-size: 0.875rem;">
                        <i class="fas fa-user-check"></i> Постоянный
                    </span>
                    {% elif client[8] == 'new' %}
                    <span class="badge" style="background: #d1fae5; color: #166534; font-size: 0.875rem;">
                        <i class="fas fa-user-plus"></i> Новый
                    </span>
                    {% endif %}
                </div>
                <p style="color: #6b7280; font-size: 1rem; margin: 0;">
                    <i class="fab fa-instagram"></i> @{{ client[1] or client[0][:15] }}
                </p>
            </div>
        </div>
        
        <button class="btn btn-primary" onclick="window.location.href='/admin/chat?client={{ client[0] }}'">
            <i class="fas fa-comment"></i>
            <span>Открыть чат</span>
        </button>
    </div>
</div>

<!-- Stats Grid -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
    <!-- Всего сообщений -->
    <div class="stat-card">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <div>
                <h3 style="font-size: 2rem; font-weight: 700; color: #111827; margin: 0 0 0.25rem 0;">{{ client[6] }}</h3>
                <p style="font-size: 0.875rem; color: #6b7280; margin: 0;">Всего сообщений</p>
            </div>
            <div style="width: 40px; height: 40px; background: #eff6ff; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-comments" style="color: #3b82f6;"></i>
            </div>
        </div>
    </div>
    
    <!-- Записей -->
    <div class="stat-card">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <div>
                <h3 style="font-size: 2rem; font-weight: 700; color: #111827; margin: 0 0 0.25rem 0;">{{ bookings|length }}</h3>
                <p style="font-size: 0.875rem; color: #6b7280; margin: 0;">Записей</p>
            </div>
            <div style="width: 40px; height: 40px; background: #f3e8ff; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-calendar-check" style="color: #a855f7;"></i>
            </div>
        </div>
    </div>
    
    <!-- LTV -->
    <div class="stat-card">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <div>
                <h3 style="font-size: 2rem; font-weight: 700; color: #10b981; margin: 0 0 0.25rem 0;">{{ client[9] }}</h3>
                <p style="font-size: 0.875rem; color: #6b7280; margin: 0;">LTV (AED)</p>
            </div>
            <div style="width: 40px; height: 40px; background: #d1fae5; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-dollar-sign" style="color: #10b981;"></i>
            </div>
        </div>
    </div>
    
    <!-- Последний контакт -->
    <div class="stat-card">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <div>
                <h3 style="font-size: 1.25rem; font-weight: 700; color: #111827; margin: 0 0 0.25rem 0;">
                    {{ client[5][:10] if client[5] else '-' }}
                </h3>
                <p style="font-size: 0.875rem; color: #6b7280; margin: 0;">Последний контакт</p>
            </div>
            <div style="width: 40px; height: 40px; background: #fef3c7; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-clock" style="color: #f59e0b;"></i>
            </div>
        </div>
    </div>
</div>

<!-- Main Content Grid -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
    <!-- Контактная информация -->
    <div class="card">
        <div class="card-header">
            <h2 style="font-size: 1.25rem; font-weight: 600; color: #111827; display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                <i class="fas fa-address-card" style="color: #ec4899;"></i>
                Контактная информация
            </h2>
        </div>
        <div class="card-body">
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div style="padding: 1rem; border-bottom: 1px solid #f3f4f6;">
                    <label style="font-size: 0.875rem; font-weight: 600; color: #6b7280; display: block; margin-bottom: 0.5rem;">Имя</label>
                    <input type="text" id="clientName" class="form-input" value="{{ client[3] or '' }}" placeholder="Не указано">
                </div>
                
                <div style="padding: 1rem; border-bottom: 1px solid #f3f4f6;">
                    <label style="font-size: 0.875rem; font-weight: 600; color: #6b7280; display: block; margin-bottom: 0.5rem;">Телефон</label>
                    <input type="text" id="clientPhone" class="form-input" value="{{ client[2] or '' }}" placeholder="Не указано">
                </div>
                
                <div style="padding: 1rem; border-bottom: 1px solid #f3f4f6;">
                    <label style="font-size: 0.875rem; font-weight: 600; color: #6b7280; display: block; margin-bottom: 0.5rem;">Instagram</label>
                    {% if client[1] %}
                    <a href="https://instagram.com/{{ client[1] }}" target="_blank" style="color: #ec4899; font-weight: 500; text-decoration: none;">
                        @{{ client[1] }}
                    </a>
                    {% else %}
                    <span style="color: #9ca3af;">{{ client[0][:30] }}...</span>
                    {% endif %}
                </div>
                
                <div style="padding: 1rem; border-bottom: 1px solid #f3f4f6;">
                    <label style="font-size: 0.875rem; font-weight: 600; color: #6b7280; display: block; margin-bottom: 0.5rem;">Статус</label>
                    <select id="clientStatus" class="form-input" onchange="updateStatus()">
                        <option value="new" {% if client[8] == 'new' %}selected{% endif %}>Новый</option>
                        <option value="regular" {% if client[8] == 'regular' %}selected{% endif %}>Постоянный</option>
                        <option value="vip" {% if client[8] == 'vip' %}selected{% endif %}>VIP</option>
                    </select>
                </div>
                
                <div style="padding: 1rem;">
                    <label style="font-size: 0.875rem; font-weight: 600; color: #6b7280; display: block; margin-bottom: 0.5rem;">Первый контакт</label>
                    <span style="color: #111827;">{{ client[4][:16] if client[4] else '-' }}</span>
                </div>
                
                <button class="btn btn-primary" style="width: 100%; margin-top: 1rem;" onclick="saveClientInfo()">
                    <i class="fas fa-save"></i>
                    <span>Сохранить изменения</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Заметки -->
    <div class="card">
        <div class="card-header">
            <h2 style="font-size: 1.25rem; font-weight: 600; color: #111827; display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                <i class="fas fa-sticky-note" style="color: #f59e0b;"></i>
                Заметки
            </h2>
        </div>
        <div class="card-body">
            <textarea id="clientNotes" class="form-input" rows="10" placeholder="Добавьте заметки о клиенте..." style="resize: vertical;">{{ client[11] if client|length > 11 else '' }}</textarea>
            <button class="btn btn-primary" style="width: 100%; margin-top: 1rem;" onclick="saveNotes()">
                <i class="fas fa-save"></i>
                <span>Сохранить заметки</span>
            </button>
        </div>
    </div>
</div>

<!-- История записей -->
{% if bookings %}
<div class="table-container" style="margin-bottom: 2rem;">
    <div class="card-header">
        <h2 style="font-size: 1.5rem; font-weight: 600; color: #111827; display: flex; align-items: center; gap: 0.5rem; margin: 0;">
            <i class="fas fa-calendar-alt" style="color: #a855f7;"></i>
            История записей
        </h2>
    </div>
    <div style="overflow-x: auto;">
        <table class="table">
            <thead>
                <tr>
                    <th>Услуга</th>
                    <th>Дата/Время</th>
                    <th>Статус</th>
                    <th>Доход</th>
                    <th>Создано</th>
                </tr>
            </thead>
            <tbody>
                {% for booking in bookings %}
                <tr>
                    <td style="font-weight: 600; color: #111827;">{{ booking[2] }}</td>
                    <td style="color: #6b7280;">{{ booking[3] }}</td>
                    <td>
                        {% if booking[6] == 'pending' %}
                        <span class="badge badge-warning">Ожидает</span>
                        {% elif booking[6] == 'confirmed' %}
                        <span class="badge badge-success">Подтверждена</span>
                        {% elif booking[6] == 'completed' %}
                        <span class="badge badge-info">Завершена</span>
                        {% elif booking[6] == 'cancelled' %}
                        <span class="badge badge-danger">Отменена</span>
                        {% endif %}
                    </td>
                    <td style="font-weight: 600; color: #10b981;">{{ booking[8] if booking|length > 8 else 0 }} AED</td>
                    <td style="color: #6b7280;">{{ booking[7][:16] }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- История сообщений -->
<div class="card">
    <div class="card-header">
        <h2 style="font-size: 1.5rem; font-weight: 600; color: #111827; display: flex; align-items: center; gap: 0.5rem; margin: 0;">
            <i class="fas fa-comments" style="color: #3b82f6;"></i>
            История сообщений (последние 50)
        </h2>
    </div>
    <div class="card-body" style="max-height: 600px; overflow-y: auto;">
        {% if history %}
        <div style="display: flex; flex-direction: column; gap: 1rem;">
            {% for msg in history %}
            <div style="{% if msg[1] == 'client' %}background: linear-gradient(135deg, #eff6ff 0%, #f3f4f6 100%); border-left: 4px solid #3b82f6;{% else %}background: linear-gradient(135deg, #d1fae5 0%, #f3f4f6 100%); border-left: 4px solid #10b981;{% endif %} padding: 1rem; border-radius: 12px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span style="font-weight: 600; color: #111827; display: flex; align-items: center; gap: 0.5rem;">
                        {% if msg[1] == 'client' %}
                        <i class="fas fa-user" style="color: #3b82f6;"></i> Клиент
                        {% else %}
                        <i class="fas fa-robot" style="color: #10b981;"></i> Бот
                        {% endif %}
                    </span>
                    <span style="color: #9ca3af; font-size: 0.875rem;">{{ msg[2][11:16] }}</span>
                </div>
                <div style="color: #374151; line-height: 1.5;">{{ msg[0] }}</div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div style="padding: 3rem; text-align: center;">
            <i class="fas fa-comments" style="font-size: 3rem; color: #e5e7eb; margin-bottom: 1rem;"></i>
            <p style="color: #6b7280;">Нет сообщений</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
const clientId = '{{ client[0] }}';

// Save client info
async function saveClientInfo() {
    const name = document.getElementById('clientName').value;
    const phone = document.getElementById('clientPhone').value;
    
    try {
        const response = await fetch(`/admin/api/clients/${clientId}/update`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name, phone })
        });
        
        const data = await response.json();
        if (data.success) {
            showNotification('Информация сохранена', 'success');
        } else {
            showNotification('Ошибка сохранения', 'error');
        }
    } catch (error) {
        showNotification('Ошибка соединения', 'error');
    }
}

// Update status
async function updateStatus() {
    const status = document.getElementById('clientStatus').value;
    
    try {
        const response = await fetch(`/admin/api/clients/${clientId}/status`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ status })
        });
        
        const data = await response.json();
        if (data.success) {
            showNotification('Статус обновлен', 'success');
            setTimeout(() => location.reload(), 1000);
        }
    } catch (error) {
        showNotification('Ошибка обновления', 'error');
    }
}

// Save notes
async function saveNotes() {
    const notes = document.getElementById('clientNotes').value;
    
    try {
        const response = await fetch(`/admin/api/clients/${clientId}/notes`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ notes })
        });
        
        const data = await response.json();
        if (data.success) {
            showNotification('Заметки сохранены', 'success');
        }
    } catch (error) {
        showNotification('Ошибка сохранения', 'error');
    }
}
</script>
{% endblock %}