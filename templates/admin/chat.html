{% extends "admin/base.html" %}

{% block title %}–ß–∞—Ç - {{ salon_info.name }}{% endblock %}
{% block nav_chat %}active{% endblock %}

{% block content %}
<style>
    .chat-container {
        display: flex;
        height: calc(100vh - 140px);
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    /* Clients List */
    .clients-list {
        width: 350px;
        border-right: 1px solid #e5e7eb;
        display: flex;
        flex-direction: column;
    }

    .clients-header {
        padding: 1.5rem;
        border-bottom: 1px solid #e5e7eb;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .clients-header h2 {
        color: white;
        font-size: 1.25rem;
        font-weight: 700;
        margin-bottom: 1rem;
    }

    .clients-search {
        position: relative;
    }

    .clients-search input {
        width: 100%;
        padding: 0.75rem 1rem 0.75rem 2.5rem;
        border: none;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        backdrop-filter: blur(10px);
    }

    .clients-search input::placeholder {
        color: rgba(255, 255, 255, 0.7);
    }

    .clients-search i {
        position: absolute;
        left: 0.875rem;
        top: 50%;
        transform: translateY(-50%);
        color: rgba(255, 255, 255, 0.7);
    }

    .clients-list-scroll {
        flex: 1;
        overflow-y: auto;
    }

    .client-item {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #f3f4f6;
        cursor: pointer;
        transition: all 0.2s;
    }

    .client-item:hover {
        background: #f9fafb;
    }

    .client-item.active {
        background: #ede9fe;
        border-left: 3px solid #8b5cf6;
    }

    .client-item.pinned {
        background: #fef3c7;
    }

    /* Chat Area */
    .chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .chat-header {
        padding: 1.5rem;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 10%);
    }

    .message-group {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .message-group.outgoing {
        flex-direction: row-reverse;
    }

    .message-bubble {
        max-width: 60%;
        padding: 0.875rem 1.125rem;
        border-radius: 16px;
        position: relative;
        animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message-bubble.incoming {
        background: white;
        border-bottom-left-radius: 4px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .message-bubble.outgoing {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom-right-radius: 4px;
    }

    .message-time {
        font-size: 0.75rem;
        opacity: 0.7;
        margin-top: 0.25rem;
    }

    .chat-input-area {
        padding: 1.5rem;
        border-top: 1px solid #e5e7eb;
        background: white;
    }

    .chat-input-wrapper {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .chat-input {
        flex: 1;
        padding: 0.875rem 1.125rem;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        resize: none;
        font-family: inherit;
        transition: all 0.2s;
    }

    .chat-input:focus {
        outline: none;
        border-color: #8b5cf6;
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }

    .chat-btn {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        border: none;
        background: #f3f4f6;
        color: #6b7280;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .chat-btn:hover {
        background: #e5e7eb;
        color: #111827;
    }

    .chat-btn-send {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        width: auto;
        padding: 0 1.5rem;
    }

    .chat-btn-send:hover {
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        transform: translateY(-2px);
    }

    /* Client Info Panel */
    .client-info {
        width: 320px;
        border-left: 1px solid #e5e7eb;
        padding: 1.5rem;
        overflow-y: auto;
    }

    .client-avatar-large {
        width: 80px;
        height: 80px;
        border-radius: 16px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 2rem;
        font-weight: 700;
        margin: 0 auto 1rem;
    }

    .info-section {
        background: #f9fafb;
        padding: 1rem;
        border-radius: 12px;
        margin-bottom: 1rem;
    }

    .info-section h3 {
        font-size: 0.875rem;
        font-weight: 600;
        color: #6b7280;
        margin-bottom: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .info-field {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid #e5e7eb;
    }

    .info-field:last-child {
        border-bottom: none;
    }

    .info-label {
        color: #6b7280;
        font-size: 0.875rem;
    }

    .info-value {
        color: #111827;
        font-weight: 600;
        font-size: 0.875rem;
    }

    /* Empty State */
    .empty-state {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #9ca3af;
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.3;
    }

    .empty-state h3 {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #6b7280;
    }

    .empty-state p {
        font-size: 0.875rem;
    }
</style>

<div class="chat-container">
    <!-- Clients List -->
    <div class="clients-list">
        <div class="clients-header">
            <h2>üí¨ –ß–∞—Ç—ã</h2>
            <div class="clients-search">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="–ü–æ–∏—Å–∫..." id="chatSearch" onkeyup="searchChats()">
            </div>
        </div>
        
        <div class="clients-list-scroll" id="clientsList">
            {% if chats %}
                {% for chat in chats %}
                <div class="client-item {% if active_client == chat.instagram_id %}active{% endif %} {% if chat.is_pinned %}pinned{% endif %}"
                     onclick="openChat('{{ chat.instagram_id }}')"
                     data-client-id="{{ chat.instagram_id }}"
                     data-name="{{ chat.name or chat.username or '–ö–ª–∏–µ–Ω—Ç' }}">
                    <div class="flex items-center gap-3">
                        <div class="relative">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-400 to-pink-600 flex items-center justify-center text-white font-bold overflow-hidden">
                                {% if chat.profile_pic %}
                                <img src="{{ chat.profile_pic }}" alt="{{ chat.name }}" class="w-full h-full object-cover">
                                {% else %}
                                <span>{{ chat.name[0] if chat.name else chat.username[0] if chat.username else '?' }}</span>
                                {% endif %}
                            </div>
                            {% if chat.unread_count > 0 %}
                            <span class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full flex items-center justify-center text-white text-xs font-bold">
                                {{ chat.unread_count }}
                            </span>
                            {% endif %}
                        </div>
                        
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm font-semibold text-gray-900 truncate flex items-center gap-1">
                                    {% if chat.is_pinned %}
                                    <i class="fas fa-thumbtack text-amber-500"></i>
                                    {% endif %}
                                    {{ chat.display_name }}
                                </span>
                                <span class="text-xs text-gray-500">{{ chat.last_message_time }}</span>
                            </div>
                            <div class="text-xs text-gray-600 truncate">
                                {{ chat.last_message[:40] }}...
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="p-8 text-center text-gray-500">
                    <i class="fas fa-comments text-6xl opacity-20 mb-4"></i>
                    <p class="font-medium">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Chat Area -->
    {% if active_client %}
    <div class="chat-area">
        <div class="chat-header">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-400 to-pink-600 flex items-center justify-center text-white font-bold overflow-hidden">
                    {% if active_client_info.profile_pic %}
                    <img src="{{ active_client_info.profile_pic }}" alt="{{ active_client_info.name }}" class="w-full h-full object-cover">
                    {% else %}
                    <span>{{ active_client_info.name[0] if active_client_info.name else '?' }}</span>
                    {% endif %}
                </div>
                <div>
                    <h3 class="font-bold text-gray-900">
                        {{ active_client_info.name or active_client_info.username or '–ö–ª–∏–µ–Ω—Ç' }}
                    </h3>
                    {% if active_client_info.phone %}
                    <p class="text-sm text-gray-600">{{ active_client_info.phone }}</p>
                    {% endif %}
                </div>
            </div>
            <button class="chat-btn" onclick="toggleClientInfo()">
                <i class="fas fa-info-circle"></i>
            </button>
        </div>

        <div class="chat-messages" id="chatMessages">
            {% for message in messages %}
            <div class="message-group {% if message.sender == 'bot' %}outgoing{% else %}incoming{% endif %}">
                <div class="message-bubble {% if message.sender == 'bot' %}outgoing{% else %}incoming{% endif %}">
                    <div>{{ message.message }}</div>
                    <div class="message-time">{{ message.timestamp[11:16] }}</div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="chat-input-area">
            <div class="chat-input-wrapper">
                <button class="chat-btn" onclick="attachImage()" title="–§–æ—Ç–æ">
                    <i class="fas fa-image"></i>
                </button>
                <button class="chat-btn" onclick="attachFile()" title="–§–∞–π–ª">
                    <i class="fas fa-paperclip"></i>
                </button>
                <textarea class="chat-input" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1" onkeypress="handleKeyPress(event)"></textarea>
                <button class="chat-btn chat-btn-send" onclick="sendMessage()">
                    <i class="fas fa-paper-plane mr-2"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                </button>
            </div>
            <input type="file" id="fileInput" style="display: none;" accept=".pdf,.doc,.docx,.txt" onchange="handleFileSelect(event, false)">
            <input type="file" id="imageInput" style="display: none;" accept="image/*" onchange="handleFileSelect(event, true)">
        </div>
    </div>

    <!-- Client Info -->
    <div class="client-info" id="clientInfoPanel">
        <div class="text-center mb-6">
            <div class="client-avatar-large">
                {{ active_client_info.name[0] if active_client_info.name else '?' }}
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-1">
                {{ active_client_info.name or '–ö–ª–∏–µ–Ω—Ç' }}
            </h3>
            <p class="text-sm text-gray-600">@{{ active_client_info.username or active_client_info.instagram_id[:15] }}</p>
        </div>

        <div class="info-section">
            <h3>–ö–æ–Ω—Ç–∞–∫—Ç—ã</h3>
            <div class="info-field">
                <span class="info-label">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
                <span class="info-value">{{ active_client_info.phone or '-' }}</span>
            </div>
        </div>

        <div class="info-section">
            <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
            <div class="info-field">
                <span class="info-label">–°–æ–æ–±—â–µ–Ω–∏–π:</span>
                <span class="info-value">{{ active_client_info.total_messages }}</span>
            </div>
            <div class="info-field">
                <span class="info-label">LTV:</span>
                <span class="info-value text-green-600">{{ active_client_info.lifetime_value }} AED</span>
            </div>
        </div>

        <div class="info-section">
            <h3>–°—Ç–∞—Ç—É—Å</h3>
            <select class="w-full p-2 border border-gray-300 rounded-lg" id="clientStatus" onchange="updateClientStatus(this.value)">
                {% for key, status in client_statuses.items() %}
                <option value="{{ key }}" {% if active_client_info.status==key %}selected{% endif %}>
                    {{ status.label }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="info-section">
            <h3>–ó–∞–º–µ—Ç–∫–∏</h3>
            <textarea class="w-full p-2 border border-gray-300 rounded-lg resize-none" id="clientNotes" rows="4" placeholder="–î–æ–±–∞–≤—å—Ç–µ –∑–∞–º–µ—Ç–∫–∏..." onblur="saveNotes()">{{ active_client_info.notes or '' }}</textarea>
        </div>
    </div>
    {% else %}
    <div class="chat-area">
        <div class="empty-state">
            <i class="fas fa-comment-dots"></i>
            <h3>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
            <p>–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –¥–ª—è –Ω–∞—á–∞–ª–∞ –æ–±—â–µ–Ω–∏—è</p>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
const activeClient = '{{ active_client }}';

function openChat(clientId) {
    if (!clientId || activeClient === clientId) return;
    window.location.href = `/admin/chat?client=${clientId}`;
}

function searchChats() {
    const input = document.getElementById('chatSearch');
    const filter = input.value.toUpperCase();
    const items = document.querySelectorAll('.client-item');

    items.forEach(item => {
        const text = item.textContent || item.innerText;
        item.style.display = text.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
    });
}

function handleKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
    }
}

async function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();

    if (!message || !activeClient) return;

    try {
        const response = await fetch('/admin/api/chat/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                instagram_id: activeClient,
                message: message
            })
        });

        const data = await response.json();

        if (data.success) {
            input.value = '';
            await loadMessages();
            showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
        } else {
            showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏', 'error');
        }
    } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
    }
}

async function loadMessages() {
    if (!activeClient) return;

    try {
        const response = await fetch(`/admin/api/chat/messages?client=${activeClient}`);
        const data = await response.json();

        if (data.messages) {
            const container = document.getElementById('chatMessages');
            container.innerHTML = '';

            data.messages.forEach(msg => {
                const messageGroup = document.createElement('div');
                messageGroup.className = `message-group ${msg.sender === 'bot' ? 'outgoing' : 'incoming'}`;
                
                messageGroup.innerHTML = `
                    <div class="message-bubble ${msg.sender === 'bot' ? 'outgoing' : 'incoming'}">
                        <div>${msg.message}</div>
                        <div class="message-time">${msg.timestamp.substring(11, 16)}</div>
                    </div>
                `;
                
                container.appendChild(messageGroup);
            });

            container.scrollTop = container.scrollHeight;
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
    }
}

function toggleClientInfo() {
    const panel = document.getElementById('clientInfoPanel');
    if (panel) {
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }
}

async function updateClientStatus(status) {
    try {
        const response = await fetch(`/admin/api/clients/${activeClient}/status`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: status })
        });

        const data = await response.json();
        if (data.success) {
            showNotification('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
        }
    } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è', 'error');
    }
}

async function saveNotes() {
    if (!activeClient) return;

    const notes = document.getElementById('clientNotes').value;

    try {
        const response = await fetch(`/admin/api/clients/${activeClient}/notes`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ notes: notes })
        });

        const data = await response.json();
        if (data.success) {
            showNotification('–ó–∞–º–µ—Ç–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
        }
    } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
    }
}

function attachFile() {
    document.getElementById('fileInput').click();
}

function attachImage() {
    document.getElementById('imageInput').click();
}

async function handleFileSelect(event, isImage) {
    const file = event.target.files[0];
    if (!file) return;

    if (file.size > 10 * 1024 * 1024) {
        showNotification('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å 10MB)', 'error');
        return;
    }

    const formData = new FormData();
    formData.append('file', file);
    formData.append('instagram_id', activeClient);
    formData.append('is_image', isImage);

    try {
        const response = await fetch('/admin/api/chat/upload', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            showNotification(isImage ? '–ö–∞—Ä—Ç–∏–Ω–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞' : '–§–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'success');
            await loadMessages();
        } else {
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', 'error');
        }
    } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', 'error');
    }

    event.target.value = '';
}

// Auto scroll
if (activeClient) {
    const chatMessages = document.getElementById('chatMessages');
    if (chatMessages) {
        setTimeout(() => {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }, 100);
    }

    setInterval(loadMessages, 3000);
}
</script>
{% endblock %}