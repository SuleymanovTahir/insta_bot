{% extends "admin/base.html" %}

{% block title %}–ß–∞—Ç —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏ - {{ salon_info.name }}{% endblock %}

{% block nav_chat %}active{% endblock %}

{% block content %}
<div class="flex h-[calc(100vh-2rem)] gap-0 bg-gray-50">
    <!-- –°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ -->
    <div class="w-80 bg-white border-r border-gray-200 flex flex-col">
        <div class="p-4 border-b border-gray-200">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-semibold text-gray-900">–ß–∞—Ç—ã</h3>
                {% if unread_count > 0 %}
                <span class="badge badge-danger text-xs font-semibold bg-red-500 text-white px-2 py-1 rounded-full" id="totalUnreadBadge">{{ unread_count }}</span>
                {% endif %}
            </div>
            <input type="text" 
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent" 
                   placeholder="üîç –ü–æ–∏—Å–∫..." 
                   onkeyup="searchChats()" 
                   id="chatSearch">
        </div>
        
        <!-- –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ -->
        <div class="flex-1 overflow-y-auto" id="clientsList">
            {% if chats %}
            {% for chat in chats %}
            <div class="p-4 border-b border-gray-100 hover:bg-gray-50 cursor-pointer transition-colors {% if active_client == chat.instagram_id %}bg-gray-100{% endif %} {% if chat.is_pinned %}bg-gradient-to-r from-amber-50 to-white border-l-4 border-amber-500{% endif %}"
                 onclick="openChat('{{ chat.instagram_id }}')"
                 data-client-id="{{ chat.instagram_id }}"
                 data-name="{{ chat.name or chat.username or '–ö–ª–∏–µ–Ω—Ç' }}"
                 data-username="{{ chat.username or '' }}">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden">
                        {% if chat.profile_pic %}
                        <img src="{{ chat.profile_pic }}" alt="{{ chat.name }}"
                             class="w-full h-full object-cover">
                        {% else %}
                        <span class="text-gray-600 font-medium">{{ chat.name[0] if chat.name else chat.username[0] if chat.username else '?' }}</span>
                        {% endif %}
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium text-gray-900">
                                {% if chat.is_pinned %}<i class="fas fa-thumbtack text-amber-500 mr-1"></i>{% endif %}
                                {{ chat.display_name }}
                            </span>
                            <span class="text-xs text-gray-500" data-time="{{ chat.last_message_time }}">{{ chat.last_message_time }}</span>
                        </div>
                        <div class="text-xs text-gray-600 mt-1" data-last-message>{{ chat.last_message[:50] }}...</div>
                        <div class="flex justify-between items-center mt-1">
                            {% if chat.instagram_url %}
                            <a href="{{ chat.instagram_url }}" target="_blank" onclick="event.stopPropagation();" class="text-xs text-gray-500 hover:text-pink-600">
                                <i class="fab fa-instagram"></i> @{{ chat.username }}
                            </a>
                            {% else %}
                            <span class="text-xs text-gray-400">{{ chat.instagram_id[:20] }}...</span>
                            {% endif %}
                            <span class="text-xs font-semibold px-2 py-1 rounded-full badge badge-{{ chat.status }}">
                                {{ client_statuses[chat.status].label if chat.status in client_statuses else chat.status }}
                            </span>
                        </div>
                    </div>
                    {% if chat.unread_count > 0 %}
                    <span class="client-item-badge text-xs font-semibold bg-pink-500 text-white px-2 py-1 rounded-full" data-unread-count>{{ chat.unread_count }}</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="p-8 text-center text-gray-500">
                <i class="fas fa-comments text-4xl opacity-30 mb-4"></i>
                <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- –û–±–ª–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π -->
    <div class="flex-1 flex flex-col bg-white">
        {% if active_client %}
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ -->
        <div class="p-4 border-b border-gray-200 bg-gradient-to-r from-pink-50 to-purple-50">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden">
                        {% if active_client_info.profile_pic %}
                        <img src="{{ active_client_info.profile_pic }}" alt="{{ active_client_info.name }}" class="w-full h-full object-cover">
                        {% else %}
                        <span class="text-gray-600 font-medium">{{ active_client_info.name[0] if active_client_info.name else '?' }}</span>
                        {% endif %}
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                            {{ active_client_info.name or active_client_info.username or '–ö–ª–∏–µ–Ω—Ç' }}
                            <button class="text-gray-500 hover:text-amber-500" onclick="pinClient('{{ active_client }}')" title="–ó–∞–∫—Ä–µ–ø–∏—Ç—å">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                        </h3>
                        <div class="flex items-center gap-2 text-sm text-gray-600">
                            {% if active_client_info.phone %}
                            <span><i class="fas fa-phone"></i> {{ active_client_info.phone }}</span>
                            {% endif %}
                            {% if active_client_info.instagram_url %}
                            <a href="{{ active_client_info.instagram_url }}" target="_blank" class="text-indigo-600 hover:text-indigo-800">
                                <i class="fab fa-instagram"></i> @{{ active_client_info.username }}
                            </a>
                            {% endif %}
                        </div>
                        <p id="typingIndicator" class="text-sm text-green-500 hidden">
                            <i class="fas fa-circle text-[0.5em] animate-pulse"></i> –ü–µ—á–∞—Ç–∞–µ—Ç...
                        </p>
                    </div>
                </div>
                <div>
                    <button class="btn btn-sm btn-info text-indigo-600 hover:bg-indigo-100 px-3 py-1 rounded-lg" onclick="toggleClientInfo()" id="toggleInfoBtn">
                        <i class="fas fa-info-circle"></i> –ò–Ω—Ñ–æ
                    </button>
                </div>
            </div>
        </div>
        
        <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
        <div class="flex-1 overflow-y-auto p-4 space-y-4" id="chatMessages">
            {% for message in messages %}
            <div class="chat-message {% if message.sender == 'client' %}incoming{% else %}outgoing{% endif %}" data-message-id="{{ loop.index }}">
                <div class="message-bubble max-w-[70%] p-3 rounded-lg {% if message.sender == 'client' %}bg-gray-100{% else %}bg-indigo-100 text-gray-900{% endif %}">
                    <div class="message-content">
                        {% if message.type == 'voice' %}
                        {% set voice_parts = message.message.split('|') %}
                        {% if voice_parts|length >= 2 %}
                        {% set duration = voice_parts[0].replace('üé§', '').replace('s', '').strip() %}
                        {% set filename = voice_parts[1].strip() %}
                        <div class="message-audio flex items-center gap-2">
                            <button class="audio-play-btn text-indigo-600 hover:text-indigo-800" onclick="playVoiceMessage('/static/uploads/voice/{{ filename }}', this)">
                                <i class="fas fa-play"></i>
                            </button>
                            <div class="audio-waveform h-6 w-24 bg-gray-200 rounded"></div>
                            <span class="audio-duration text-xs">{{ duration }}s</span>
                        </div>
                        {% else %}
                        {{ message.message }}
                        {% endif %}
                        {% elif message.type == 'image' %}
                        {% set filename = message.message.replace('üñºÔ∏è', '').strip() %}
                        <div class="message-image-wrapper cursor-pointer" onclick="openImageModal('/static/uploads/images/{{ filename }}')">
                            <img src="/static/uploads/images/{{ filename }}" alt="Image" class="message-image max-w-full rounded-lg"
                                 onerror="this.parentElement.innerHTML='<div class=&quot;p-4 text-center text-red-500&quot;><i class=&quot;fas fa-exclamation-triangle&quot;></i><br>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>'">
                        </div>
                        {% elif message.type == 'file' %}
                        {% set filename = message.message.replace('üìé', '').strip() %}
                        <a href="/static/uploads/files/{{ filename }}" class="message-file-link flex items-center gap-2 text-indigo-600 hover:text-indigo-800" download>
                            <i class="fas fa-file-alt"></i>
                            <span>{{ filename[:30] }}{% if filename|length > 30 %}...{% endif %}</span>
                            <i class="fas fa-download"></i>
                        </a>
                        {% else %}
                        {{ message.message }}
                        {% endif %}
                    </div>
                    <div class="message-meta flex items-center gap-2 mt-1 text-xs text-gray-500">
                        <span class="message-time">{{ message.timestamp[11:16] }}</span>
                        {% if message.sender == 'bot' %}
                        <span class="message-status"><i class="fas fa-check-double text-indigo-600"></i></span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ -->
        <div class="p-4 border-t border-gray-200 bg-white">
            <div class="flex items-center gap-2">
                <button class="btn-icon text-gray-500 hover:text-indigo-600" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ" onclick="attachImage()">
                    <i class="fas fa-image"></i>
                </button>
                <button class="btn-icon text-gray-500 hover:text-indigo-600" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª" onclick="attachFile()">
                    <i class="fas fa-paperclip"></i>
                </button>
                <button class="btn-icon text-gray-500 hover:text-indigo-600" id="voiceBtn" title="–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" onclick="recordVoice()">
                    <i class="fas fa-microphone"></i>
                </button>
                <textarea class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent resize-none" 
                          id="messageInput" 
                          placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                          rows="1" 
                          oninput="handleTyping()" 
                          onkeypress="handleKeyPress(event)"></textarea>
                <button class="btn btn-primary btn-send bg-pink-500 hover:bg-pink-600 text-white px-4 py-2 rounded-lg" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            <input type="file" id="fileInput" style="display: none;" accept=".pdf,.doc,.docx,.txt,.zip,.rar" onchange="handleFileSelect(event, false)">
            <input type="file" id="imageInput" style="display: none;" accept="image/*" onchange="handleFileSelect(event, true)">
        </div>
        
        <!-- –ú–æ–¥–∞–ª –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–∞—Ä—Ç–∏–Ω–æ–∫ -->
        <div class="image-modal fixed inset-0 bg-black bg-opacity-75 hidden flex items-center justify-center" id="imageModal" onclick="closeImageModal()">
            <span class="image-modal-close absolute top-4 right-4 text-white text-2xl cursor-pointer">&times;</span>
            <img class="image-modal-content max-w-[90%] max-h-[90%]" id="modalImage">
        </div>
        {% else %}
        <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
        <div class="flex-1 flex items-center justify-center text-gray-500">
            <div class="text-center">
                <i class="fas fa-comment-dots text-4xl opacity-30 mb-4"></i>
                <h3 class="text-lg font-semibold">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
                <p>–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</p>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- –ü–∞–Ω–µ–ª—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–ª–∏–µ–Ω—Ç–µ -->
    {% if active_client_info %}
    <div class="w-80 bg-white border-l border-gray-200 hidden lg:flex flex-col" id="clientInfoPanel">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-semibold text-gray-900">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
            <button class="text-gray-500 hover:text-indigo-600" onclick="toggleClientInfo()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-4 flex-1 overflow-y-auto">
            <div class="text-center mb-6">
                <div class="w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden mx-auto">
                    {% if active_client_info.profile_pic %}
                    <img src="{{ active_client_info.profile_pic }}" alt="{{ active_client_info.name }}" class="w-full h-full object-cover">
                    {% else %}
                    <span class="text-gray-600 font-medium">{{ active_client_info.name[0] if active_client_info.name else '?' }}</span>
                    {% endif %}
                </div>
                <h3 contenteditable="true" id="clientName" onblur="updateClientField('name', this.textContent)" class="text-lg font-semibold mt-2">
                    {{ active_client_info.name or '–ö–ª–∏–µ–Ω—Ç' }}
                </h3>
                <p class="text-sm text-gray-500">@{{ active_client_info.username or active_client_info.instagram_id[:15] }}</p>
            </div>
            <div class="space-y-6">
                <div>
                    <h4 class="text-sm font-medium text-gray-900"><i class="fas fa-user mr-1"></i> –ö–æ–Ω—Ç–∞–∫—Ç—ã</h4>
                    <div class="mt-2">
                        <span class="block text-xs text-gray-600">–¢–µ–ª–µ—Ñ–æ–Ω</span>
                        <input type="text" class="info-value-edit w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent mt-1"
                               id="clientPhone" value="{{ active_client_info.phone or '' }}" placeholder="–ù–µ —É–∫–∞–∑–∞–Ω"
                               onblur="updateClientField('phone', this.value)">
                    </div>
                    <div class="mt-2">
                        <span class="block text-xs text-gray-600">Instagram</span>
                        {% if active_client_info.instagram_url %}
                        <a href="{{ active_client_info.instagram_url }}" target="_blank" class="text-sm text-indigo-600 hover:text-indigo-800">
                            @{{ active_client_info.username }}
                        </a>
                        {% else %}
                        <span class="text-sm text-gray-500">{{ active_client_info.instagram_id[:20] }}...</span>
                        {% endif %}
                    </div>
                </div>
                <div>
                    <h4 class="text-sm font-medium text-gray-900"><i class="fas fa-chart-line mr-1"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h4>
                    <div class="mt-2 space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">–°–æ–æ–±—â–µ–Ω–∏–π</span>
                            <span>{{ active_client_info.total_messages }}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">–ü–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç</span>
                            <span>{{ active_client_info.first_contact[:10] }}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">–ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–Ω—Ç–∞–∫—Ç</span>
                            <span>{{ active_client_info.last_contact[:10] }}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">LTV</span>
                            <span>{{ active_client_info.lifetime_value }} AED</span>
                        </div>
                    </div>
                </div>
                <div>
                    <h4 class="text-sm font-medium text-gray-900"><i class="fas fa-tag mr-1"></i> –°—Ç–∞—Ç—É—Å</h4>
                    <select class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent mt-2"
                            id="clientStatus" onchange="updateClientStatus(this.value)">
                        {% for key, status in client_statuses.items() %}
                        <option value="{{ key }}" {% if active_client_info.status==key %}selected{% endif %}>
                            {{ status.label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <h4 class="text-sm font-medium text-gray-900"><i class="fas fa-sticky-note mr-1"></i> –ó–∞–º–µ—Ç–∫–∏</h4>
                    <textarea class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent mt-2 resize-none"
                              id="clientNotes" placeholder="–î–æ–±–∞–≤—å—Ç–µ –∑–∞–º–µ—Ç–∫–∏ –æ –∫–ª–∏–µ–Ω—Ç–µ..." onblur="saveNotes()">{{ active_client_info.notes or '' }}</textarea>
                </div>
                <div>
                    <button class="w-full bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg flex items-center justify-center gap-2"
                            onclick="blockClient()">
                        <i class="fas fa-ban"></i> –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.3; }
    }
    .info-value-edit {
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 6px 10px;
        font-size: 0.95em;
        width: 100%;
        transition: border-color 0.3s;
    }
    .info-value-edit:focus {
        outline: none;
        border-color: #667eea;
    }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
    const activeClient = '{{ active_client }}';
    let lastMessageCount = {{ messages| length if messages else 0 }};
    let isAutoScrollEnabled = true;
    let typingTimeout;

    // ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –û–ë–†–ê–ë–û–¢–ß–ò–ö–û–í –ö–õ–ò–ö–û–í =====
    document.addEventListener('DOMContentLoaded', function () {
        console.log('üü¢ DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤...');

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–∞ –Ω–∞ –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∫–ª–∏–µ–Ω—Ç–æ–≤
        document.querySelectorAll('.client-item').forEach(item => {
            const clientId = item.getAttribute('data-client-id');

            if (clientId) {
                item.addEventListener('click', function (e) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ –ø–æ —Å—Å—ã–ª–∫–∞–º –≤–Ω—É—Ç—Ä–∏
                    if (e.target.tagName === 'A' || e.target.closest('a')) {
                        return;
                    }

                    console.log('üñ±Ô∏è –ö–ª–∏–∫ –ø–æ –∫–ª–∏–µ–Ω—Ç—É:', clientId);
                    openChat(clientId);
                });
            }
        });

        console.log('‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è', document.querySelectorAll('.client-item').length, '–∫–ª–∏–µ–Ω—Ç–æ–≤');
    });

    // ===== –§–£–ù–ö–¶–ò–Ø –û–¢–ö–†–´–¢–ò–Ø –ß–ê–¢–ê =====
    function openChat(clientId) {
        console.log('üìû openChat –≤—ã–∑–≤–∞–Ω —Å:', clientId);
        console.log('üìç –¢–µ–∫—É—â–∏–π activeClient:', activeClient);

        if (!clientId) {
            console.error('‚ùå clientId –ø—É—Å—Ç–æ–π!');
            return;
        }

        // –ï—Å–ª–∏ —ç—Ç–æ —É–∂–µ –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç
        if (activeClient === clientId) {
            console.log('‚ÑπÔ∏è –ß–∞—Ç —É–∂–µ –æ—Ç–∫—Ä—ã—Ç');
            return;
        }

        // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º
        const url = `/admin/chat?client=${clientId}`;
        console.log('üöÄ –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞:', url);
        window.location.href = url;
    }

    // ===== –ü–û–ò–°–ö –ß–ê–¢–û–í =====
    function searchChats() {
        const input = document.getElementById('chatSearch');
        const filter = input.value.toUpperCase();
        const items = document.querySelectorAll('.client-item');

        items.forEach(item => {
            const text = item.textContent || item.innerText;
            item.style.display = text.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
        });
    }

    // ===== –û–ë–†–ê–ë–û–¢–ö–ê ENTER =====
    function handleKeyPress(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    }

    // ===== –ê–í–¢–û-–†–ï–°–ê–ô–ó TEXTAREA =====
    const messageInput = document.getElementById('messageInput');
    if (messageInput) {
        messageInput.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
    }

    // ===== –ò–ù–î–ò–ö–ê–¢–û–† –ü–ï–ß–ê–¢–ò =====
    function handleTyping() {
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            // –ö–ª–∏–µ–Ω—Ç –ø–µ—Ä–µ—Å—Ç–∞–ª –ø–µ—á–∞—Ç–∞—Ç—å
        }, 1000);
    }

    // ===== –í–û–°–ü–†–û–ò–ó–í–ï–î–ï–ù–ò–ï –ì–û–õ–û–°–û–í–´–• –°–û–û–ë–©–ï–ù–ò–ô =====
    let currentAudio = null;
    let currentButton = null;

    function playVoiceMessage(filePath, button) {
        const icon = button.querySelector('i');
        const waveform = button.parentElement.querySelector('.audio-waveform');
        const durationSpan = button.parentElement.querySelector('.audio-duration');

        if (currentAudio && !currentAudio.paused && currentButton === button) {
            currentAudio.pause();
            icon.className = 'fas fa-play';
            button.classList.remove('playing');
            waveform.classList.remove('playing');
        } else {
            if (currentAudio) {
                currentAudio.pause();
                if (currentButton) {
                    currentButton.querySelector('i').className = 'fas fa-play';
                    currentButton.classList.remove('playing');
                    const prevWave = currentButton.parentElement.querySelector('.audio-waveform');
                    if (prevWave) prevWave.classList.remove('playing');
                }
            }

            currentAudio = new Audio(filePath);
            currentButton = button;

            currentAudio.addEventListener('loadedmetadata', () => {
                const totalDuration = Math.floor(currentAudio.duration);
                durationSpan.textContent = totalDuration + 's';
            });

            currentAudio.addEventListener('timeupdate', () => {
                const remaining = Math.ceil(currentAudio.duration - currentAudio.currentTime);
                durationSpan.textContent = remaining + 's';
            });

            currentAudio.play();
            icon.className = 'fas fa-pause';
            button.classList.add('playing');
            waveform.classList.add('playing');

            currentAudio.onended = () => {
                icon.className = 'fas fa-play';
                button.classList.remove('playing');
                waveform.classList.remove('playing');
                currentButton = null;
            };

            currentAudio.onerror = () => {
                showNotification('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∞—É–¥–∏–æ', 'error');
                icon.className = 'fas fa-play';
                button.classList.remove('playing');
                waveform.classList.remove('playing');
            };
        }
    }

    // ===== –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–Ø =====
    async function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();

        if (!message || !activeClient) return;

        const sendBtn = document.querySelector('.btn-send');
        sendBtn.disabled = true;
        sendBtn.style.opacity = '0.6';

        try {
            const response = await fetch('/admin/api/chat/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    instagram_id: activeClient,
                    message: message
                })
            });

            const data = await response.json();

            if (data.success) {
                input.value = '';
                input.style.height = 'auto';
                await loadMessages();
                showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
            } else {
                showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏', 'error');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
        } finally {
            sendBtn.disabled = false;
            sendBtn.style.opacity = '1';
            input.focus();
        }
    }

    // ===== –ó–ê–ì–†–£–ó–ö–ê –°–û–û–ë–©–ï–ù–ò–ô =====
    async function loadMessages() {
        if (!activeClient) return;

        try {
            const response = await fetch(`/admin/api/chat/messages?client=${activeClient}`);
            const data = await response.json();

            if (data.messages && data.messages.length !== lastMessageCount) {
                const container = document.getElementById('chatMessages');
                const wasScrolledToBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 50;

                container.innerHTML = '';

                data.messages.forEach((msg, index) => {
                    const div = createMessageElement(msg, index);
                    container.appendChild(div);
                });

                if (wasScrolledToBottom || (data.messages.length > 0 && data.messages[data.messages.length - 1].sender === 'client')) {
                    container.scrollTop = container.scrollHeight;
                }

                lastMessageCount = data.messages.length;
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
        }
    }

    // ===== –°–û–ó–î–ê–ù–ò–ï –≠–õ–ï–ú–ï–ù–¢–ê –°–û–û–ë–©–ï–ù–ò–Ø =====
    function createMessageElement(msg, index) {
        const div = document.createElement('div');
        div.className = `chat-message ${msg.sender === 'client' ? 'incoming' : 'outgoing'}`;
        div.setAttribute('data-message-id', index);

        let contentHtml = '';
        const messageText = msg.message || '';

        if (msg.type === 'voice' || messageText.includes('üé§')) {
            // –§–æ—Ä–º–∞—Ç: "üé§ 5s|1234567890_voice.webm"
            const match = messageText.match(/üé§\s*(\d+)s\|(.+)/);
            const duration = match ? match[1] : '0';
            const filename = match ? match[2].trim() : '';

            if (filename) {
                contentHtml = `
                    <div class="message-audio flex items-center gap-2">
                        <button class="audio-play-btn text-indigo-600 hover:text-indigo-800" onclick="playVoiceMessage('/static/uploads/voice/${filename}', this)">
                            <i class="fas fa-play"></i>
                        </button>
                        <div class="audio-waveform h-6 w-24 bg-gray-200 rounded"></div>
                        <span class="audio-duration text-xs">${duration}s</span>
                    </div>
                `;
            } else {
                contentHtml = escapeHtml(messageText);
            }
        } else if (msg.type === 'image' || messageText.includes('üñºÔ∏è')) {
            const filename = messageText.includes(': ') ? messageText.split(': ')[1].trim() : '';
            if (filename) {
                contentHtml = `
                    <div class="message-image-wrapper cursor-pointer" onclick="openImageModal('/admin/api/uploads/images/${filename}')">
                        <img src="/admin/api/uploads/images/${filename}" alt="Image" class="message-image max-w-full rounded-lg" 
                             onerror="this.parentElement.innerHTML='<div class=&quot;p-4 text-center text-red-500&quot;><i class=&quot;fas fa-exclamation-triangle&quot;></i><br>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>'">
                    </div>
                `;
            } else {
                contentHtml = escapeHtml(messageText);
            }
        } else if (msg.type === 'file' || messageText.includes('üìé')) {
            const fileName = messageText.includes(': ') ? messageText.split(': ')[1].trim() : '–§–∞–π–ª';
            if (fileName && fileName !== '–§–∞–π–ª') {
                contentHtml = `
                    <a href="/admin/api/uploads/files/${fileName}" class="message-file-link flex items-center gap-2 text-indigo-600 hover:text-indigo-800" download>
                        <i class="fas fa-file"></i>
                        <span>${escapeHtml(fileName.length > 30 ? fileName.substring(0, 27) + '...' : fileName)}</span>
                        <i class="fas fa-download"></i>
                    </a>
                `;
            } else {
                contentHtml = escapeHtml(messageText);
            }
        } else {
            contentHtml = escapeHtml(messageText);
        }

        div.innerHTML = `
            <div class="message-bubble max-w-[70%] p-3 rounded-lg ${msg.sender === 'client' ? 'bg-gray-100' : 'bg-indigo-100 text-gray-900'}">
                <div class="message-content">
                    ${contentHtml}
                </div>
                <div class="message-meta flex items-center gap-2 mt-1 text-xs text-gray-500">
                    <span class="message-time">${msg.timestamp.substring(11, 16)}</span>
                    ${msg.sender === 'bot' ? '<span class="message-status"><i class="fas fa-check-double text-indigo-600"></i></span>' : ''}
                </div>
            </div>
        `;

        return div;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ===== –û–°–¢–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò =====
    function toggleClientInfo() {
        const panel = document.getElementById('clientInfoPanel');
        const layout = document.querySelector('.flex');
        const btn = document.getElementById('toggleInfoBtn');

        if (panel && layout) {
            if (window.innerWidth <= 1200) {
                panel.classList.toggle('active');
                panel.style.right = panel.classList.contains('active') ? '0' : '-320px';
            } else {
                if (panel.classList.contains('hidden')) {
                    panel.classList.remove('hidden');
                    btn.classList.add('bg-indigo-600', 'text-white');
                } else {
                    panel.classList.add('hidden');
                    btn.classList.remove('bg-indigo-600', 'text-white');
                }
            }
        }
    }

    async function updateClientStatus(status) {
        try {
            const response = await fetch(`/admin/api/clients/${activeClient}/status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: status })
            });

            const data = await response.json();
            if (data.success) {
                showNotification('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                const clientItem = document.querySelector(`[data-client-id="${activeClient}"] .badge`);
                if (clientItem) {
                    clientItem.className = `text-xs font-semibold px-2 py-1 rounded-full badge badge-${status}`;
                }
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è', 'error');
        }
    }

    async function updateClientField(field, value) {
        if (!activeClient || !value) return;

        try {
            const response = await fetch(`/admin/api/clients/${activeClient}/update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ [field]: value })
            });

            const data = await response.json();
            if (data.success) {
                showNotification('–û–±–Ω–æ–≤–ª–µ–Ω–æ', 'success');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è', 'error');
        }
    }

    async function saveNotes() {
        if (!activeClient) return;

        const notes = document.getElementById('clientNotes').value;

        try {
            const response = await fetch(`/admin/api/clients/${activeClient}/notes`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ notes: notes })
            });

            const data = await response.json();
            if (data.success) {
                showNotification('–ó–∞–º–µ—Ç–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
        }
    }

    async function pinClient(clientId) {
        try {
            const response = await fetch(`/admin/api/clients/${clientId}/pin`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const data = await response.json();
            if (data.success) {
                showNotification(data.pinned ? '–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–æ' : '–û—Ç–∫—Ä–µ–ø–ª–µ–Ω–æ', 'success');
                location.reload();
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞', 'error');
        }
    }

    function attachFile() {
        document.getElementById('fileInput').click();
    }

    function attachImage() {
        document.getElementById('imageInput').click();
    }

    async function handleFileSelect(event, isImage) {
        const file = event.target.files[0];
        if (!file) return;

        if (file.size > 10 * 1024 * 1024) {
            showNotification('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å 10MB)', 'error');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);
        formData.append('instagram_id', activeClient);
        formData.append('is_image', isImage);

        try {
            showNotification(isImage ? '–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏...' : '–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞...', 'info');

            const response = await fetch('/admin/api/chat/upload', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                showNotification(isImage ? '–ö–∞—Ä—Ç–∏–Ω–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞' : '–§–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'success');
                await loadMessages();
            } else {
                showNotification(data.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', 'error');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', 'error');
        }

        event.target.value = '';
    }

    let mediaRecorder;
    let audioChunks = [];

    async function recordVoice() {
        const recordBtn = event.target.closest('.btn-icon');

        if (!mediaRecorder || mediaRecorder.state === 'inactive') {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await sendVoiceMessage(audioBlob);
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                recordBtn.classList.add('text-red-500');
                recordBtn.querySelector('i').className = 'fas fa-stop';
                showNotification('–ó–∞–ø–∏—Å—å –Ω–∞—á–∞–ª–∞—Å—å...', 'info');
            } catch (error) {
                showNotification('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É', 'error');
            }
        } else {
            mediaRecorder.stop();
            recordBtn.classList.remove('text-red-500');
            recordBtn.querySelector('i').className = 'fas fa-microphone';
        }
    }

    async function sendVoiceMessage(audioBlob) {
        const formData = new FormData();
        formData.append('voice', audioBlob, 'voice.webm');
        formData.append('instagram_id', activeClient);
        
        // –í—ã—á–∏—Å–ª—è–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ –ø–æ —Ä–∞–∑–º–µ—Ä—É)
        const duration = Math.round(audioBlob.size / 16000); // –ü—Ä–∏–º–µ—Ä–Ω–∞—è –æ—Ü–µ–Ω–∫–∞
        formData.append('duration', duration.toString());

        try {
            showNotification('–û—Ç–ø—Ä–∞–≤–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ...', 'info');

            const response = await fetch('/admin/api/chat/voice', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                showNotification('–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
                await loadMessages();
            } else {
                showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + (data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                console.error('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ', 'error');
            console.error('–û—à–∏–±–∫–∞:', error);
        }
    }
    
    function blockClient() {
        if (confirm('–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞?')) {
            updateClientStatus('blocked');
        }
    }

    function openImageModal(src) {
        const modal = document.getElementById('imageModal');
        const img = document.getElementById('modalImage');
        modal.classList.add('active');
        img.src = src;
        document.addEventListener('keydown', closeOnEscape);
    }

    function closeImageModal() {
        document.getElementById('imageModal').classList.remove('active');
        document.removeEventListener('keydown', closeOnEscape);
    }

    function closeOnEscape(e) {
        if (e.key === 'Escape') {
            closeImageModal();
        }
    }

    async function updateChatsList() {
        try {
            const response = await fetch('/admin/api/chats-update');
            const data = await response.json();

            if (data.chats) {
                data.chats.forEach(chat => {
                    const clientItem = document.querySelector(`[data-client-id="${chat.instagram_id}"]`);
                    if (clientItem) {
                        const lastMessageEl = clientItem.querySelector('[data-last-message]');
                        if (lastMessageEl && chat.last_message) {
                            lastMessageEl.textContent = chat.last_message.substring(0, 50) + '...';
                        }

                        const timeEl = clientItem.querySelector('[data-time]');
                        if (timeEl && chat.last_message_time) {
                            timeEl.textContent = chat.last_message_time;
                        }

                        let badgeEl = clientItem.querySelector('[data-unread-count]');
                        if (chat.unread_count > 0) {
                            if (!badgeEl) {
                                badgeEl = document.createElement('span');
                                badgeEl.className = 'client-item-badge text-xs font-semibold bg-pink-500 text-white px-2 py-1 rounded-full';
                                badgeEl.setAttribute('data-unread-count', '');
                                clientItem.querySelector('.flex').appendChild(badgeEl);
                            }
                            badgeEl.textContent = chat.unread_count;
                        } else if (badgeEl) {
                            badgeEl.remove();
                        }
                    }
                });

                const totalBadge = document.getElementById('totalUnreadBadge');
                if (data.total_unread > 0) {
                    if (!totalBadge) {
                        const header = document.querySelector('.p-4.border-b');
                        const newBadge = document.createElement('span');
                        newBadge.className = 'badge badge-danger text-xs font-semibold bg-red-500 text-white px-2 py-1 rounded-full';
                        newBadge.id = 'totalUnreadBadge';
                        newBadge.textContent = data.total_unread;
                        header.querySelector('.flex').appendChild(newBadge);
                    } else {
                        totalBadge.textContent = data.total_unread;
                    }
                } else if (totalBadge) {
                    totalBadge.remove();
                }
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤:', error);
        }
    }

    // ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =====
    if (activeClient) {
        setInterval(loadMessages, 3000);
        setInterval(updateChatsList, 5000);

        const chatMessages = document.getElementById('chatMessages');
        if (chatMessages) {
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 100);
        }

        const input = document.getElementById('messageInput');
        if (input) {
            input.focus();
        }
    }

    console.log('üí¨ –ß–∞—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    console.log('üì± –ê–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∏–µ–Ω—Ç:', activeClient || '–Ω–µ –≤—ã–±—Ä–∞–Ω');
    console.log('‚úÖ –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
</script>
{% endblock %}