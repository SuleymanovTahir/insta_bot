{% extends "admin/base.html" %}

{% block title %}–ß–∞—Ç - {{ salon_info.name }}{% endblock %}
{% block nav_chat %}active{% endblock %}

{% block content %}
<style>
.chat-wrapper {
    display: grid;
    grid-template-columns: 300px 1fr 280px;
    gap: 1.5rem;
    height: calc(100vh - 200px);
}

.clients-list { background: white; border-radius: 12px; border: 1px solid #e5e7eb; display: flex; flex-direction: column; overflow: hidden; }
.clients-header { padding: 1rem; background: linear-gradient(135deg, #ec4899, #8b5cf6); color: white; }
.clients-header h2 { font-size: 1.125rem; font-weight: 700; margin-bottom: 0.75rem; }
.search-input { width: 100%; padding: 0.625rem 0.75rem 0.625rem 2.25rem; border: none; border-radius: 8px; background: rgba(255,255,255,0.2); color: white; font-size: 0.875rem; position: relative; }
.search-input::placeholder { color: rgba(255,255,255,0.7); }

.clients-scroll { flex: 1; overflow-y: auto; }
.client-item { padding: 0.875rem 1rem; border-bottom: 1px solid #f3f4f6; cursor: pointer; transition: all 0.2s; display: flex; gap: 0.75rem; align-items: center; }
.client-item:hover { background: #f9fafb; }
.client-item.active { background: rgba(236, 72, 153, 0.1); border-left: 3px solid #ec4899; }

.avatar { width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, #ec4899, #8b5cf6); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.875rem; flex-shrink: 0; position: relative; }
.unread-badge { position: absolute; top: -6px; right: -6px; width: 20px; height: 20px; background: #ef4444; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.75rem; font-weight: 700; border: 2px solid white; }

.client-name { font-weight: 600; color: #111827; font-size: 0.875rem; }
.client-msg { font-size: 0.75rem; color: #6b7280; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

.chat-main { background: white; border-radius: 12px; border: 1px solid #e5e7eb; display: flex; flex-direction: column; }
.chat-header { padding: 1rem; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: space-between; }
.chat-messages { flex: 1; overflow-y: auto; padding: 1rem; background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%); }
.message-group { display: flex; margin-bottom: 1rem; }
.message-group.sent { justify-content: flex-end; }
.message-bubble { max-width: 70%; padding: 0.875rem 1.125rem; border-radius: 16px; font-size: 0.875rem; line-height: 1.5; }
.message-bubble.received { background: white; border-bottom-left-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
.message-bubble.sent { background: linear-gradient(135deg, #ec4899, #8b5cf6); color: white; border-bottom-right-radius: 4px; }
.message-time { font-size: 0.75rem; opacity: 0.7; margin-top: 0.25rem; }

.chat-input { padding: 1rem; border-top: 1px solid #e5e7eb; background: white; }
.input-wrapper { display: flex; gap: 0.75rem; align-items: flex-end; }
.input-wrapper textarea { flex: 1; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 8px; resize: none; font-family: inherit; font-size: 0.875rem; }
.input-wrapper textarea:focus { outline: none; border-color: #ec4899; box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1); }
.chat-btn { width: 40px; height: 40px; border-radius: 8px; border: 1px solid #e5e7eb; background: white; color: #6b7280; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
.chat-btn:hover { background: #f3f4f6; color: #111827; }
.btn-send { background: linear-gradient(135deg, #ec4899, #8b5cf6); color: white; border: none; width: auto; padding: 0 1rem; }
.btn-send:hover { box-shadow: 0 4px 12px rgba(236, 72, 153, 0.4); }

.client-panel { background: white; border-radius: 12px; border: 1px solid #e5e7eb; padding: 1rem; overflow-y: auto; }
.panel-section { background: #f9fafb; padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; }
.panel-section h3 { font-size: 0.75rem; font-weight: 700; color: #6b7280; text-transform: uppercase; margin-bottom: 0.5rem; }
.panel-field { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #e5e7eb; font-size: 0.875rem; }

@media (max-width: 1200px) { .chat-wrapper { grid-template-columns: 1fr; } .client-panel { display: none; } }
@media (max-width: 768px) { .chat-wrapper { grid-template-columns: 1fr; } .clients-list { display: none; } }
</style>

<div class="chat-wrapper">
    <!-- –°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ -->
    <div class="clients-list">
        <div class="clients-header">
            <h2>üí¨ –ß–∞—Ç—ã</h2>
            <div style="position: relative; margin-top: 0.75rem;">
                <i class="fas fa-search" style="position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: rgba(255,255,255,0.7);"></i>
                <input type="text" id="chatSearch" class="search-input" placeholder="–ü–æ–∏—Å–∫..." onkeyup="searchChats()">
            </div>
        </div>
        
        <div class="clients-scroll" id="clientsList">
            {% if chats %}
                {% for chat in chats %}
                <div class="client-item {% if active_client == chat.instagram_id %}active{% endif %}" 
                     onclick="openChat('{{ chat.instagram_id }}')" data-client-id="{{ chat.instagram_id }}">
                    <div class="avatar">
                        {{ chat.name[0] if chat.name else chat.username[0] if chat.username else '?' }}
                        {% if chat.unread_count > 0 %}
                        <span class="unread-badge">{{ chat.unread_count }}</span>
                        {% endif %}
                    </div>
                    <div style="flex: 1; min-width: 0;">
                        <div class="client-name">{{ chat.name or chat.username or '–ö–ª–∏–µ–Ω—Ç' }}</div>
                        <div class="client-msg">{{ chat.last_message[:30] or '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π' }}</div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div style="text-align: center; padding: 2rem 1rem; color: #9ca3af;">
                    <i class="fas fa-comments" style="font-size: 2rem; opacity: 0.3; margin-bottom: 0.5rem;"></i>
                    <p style="font-size: 0.875rem;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç -->
    {% if active_client %}
    <div class="chat-main">
        <div class="chat-header">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <div class="avatar" style="width: 40px; height: 40px;">
                    {{ active_client_info.name[0] if active_client_info.name else '?' }}
                </div>
                <div>
                    <div style="font-weight: 600; color: #111827;">{{ active_client_info.name or '–ö–ª–∏–µ–Ω—Ç' }}</div>
                    {% if active_client_info.phone %}
                    <div style="font-size: 0.75rem; color: #6b7280;">{{ active_client_info.phone }}</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="chat-messages" id="chatMessages">
            {% for message in messages %}
            <div class="message-group {% if message.sender == 'bot' %}sent{% else %}received{% endif %}">
                <div class="message-bubble {% if message.sender == 'bot' %}sent{% else %}received{% endif %}">
                    <div>{{ message.message }}</div>
                    <div class="message-time">{{ message.timestamp[11:16] }}</div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="chat-input">
            <div class="input-wrapper">
                <button class="chat-btn" onclick="attachFile()" title="–§–∞–π–ª">
                    <i class="fas fa-paperclip"></i>
                </button>
                <textarea id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1" onkeypress="handleKeyPress(event)"></textarea>
                <button class="chat-btn btn-send" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            <input type="file" id="fileInput" style="display: none;" onchange="handleFileSelect(event)">
        </div>
    </div>
    {% else %}
    <div class="chat-main" style="display: flex; align-items: center; justify-content: center;">
        <div style="text-align: center; color: #9ca3af;">
            <i class="fas fa-comment-dots" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
            <h3 style="font-size: 1.125rem; color: #6b7280; margin-bottom: 0.5rem;">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
            <p style="font-size: 0.875rem;">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –¥–ª—è –Ω–∞—á–∞–ª–∞ –æ–±—â–µ–Ω–∏—è</p>
        </div>
    </div>
    {% endif %}

    <!-- –ü–∞–Ω–µ–ª—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–ª–∏–µ–Ω—Ç–µ -->
    {% if active_client %}
    <div class="client-panel">
        <div style="text-align: center; margin-bottom: 1.5rem;">
            <div class="avatar" style="width: 64px; height: 64px; margin: 0 auto 0.75rem; font-size: 1.5rem;">
                {{ active_client_info.name[0] if active_client_info.name else '?' }}
            </div>
            <h3 style="font-weight: 700; color: #111827; margin-bottom: 0.25rem;">
                {{ active_client_info.name or '–ö–ª–∏–µ–Ω—Ç' }}
            </h3>
            {% if active_client_info.username %}
            <p style="font-size: 0.875rem; color: #6b7280;">@{{ active_client_info.username }}</p>
            {% endif %}
        </div>

        <div class="panel-section">
            <h3>–ö–æ–Ω—Ç–∞–∫—Ç—ã</h3>
            <div class="panel-field">
                <span style="color: #6b7280;">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
                <span style="font-weight: 600; color: #111827;">{{ active_client_info.phone or '-' }}</span>
            </div>
        </div>

        <div class="panel-section">
            <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
            <div class="panel-field">
                <span style="color: #6b7280;">–°–æ–æ–±—â–µ–Ω–∏–π:</span>
                <span style="font-weight: 600; color: #111827;">{{ active_client_info.total_messages }}</span>
            </div>
            <div class="panel-field">
                <span style="color: #6b7280;">LTV:</span>
                <span style="font-weight: 600; color: #10b981;">{{ active_client_info.lifetime_value }} AED</span>
            </div>
        </div>

        <div class="panel-section">
            <h3>–ó–∞–º–µ—Ç–∫–∏</h3>
            <textarea style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px; resize: none; font-size: 0.875rem;" 
                      rows="4" id="clientNotes" onblur="saveNotes()">{{ active_client_info.notes or '' }}</textarea>
        </div>
    </div>
    {% endif %}
</div>

<script>
const activeClient = '{{ active_client }}';

function openChat(clientId) {
    if (!clientId || activeClient === clientId) return;
    window.location.href = `/admin/chat?client=${clientId}`;
}

function searchChats() {
    const filter = document.getElementById('chatSearch').value.toUpperCase();
    const items = document.querySelectorAll('.client-item');
    items.forEach(item => {
        const text = item.textContent.toUpperCase();
        item.style.display = text.includes(filter) ? '' : 'none';
    });
}

function handleKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
    }
}

async function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    if (!message || !activeClient) return;

    try {
        const response = await fetch('/admin/api/chat/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ instagram_id: activeClient, message: message })
        });
        const data = await response.json();
        if (data.success) {
            input.value = '';
            await loadMessages();
            showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
        }
    } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏', 'error');
    }
}

async function loadMessages() {
    if (!activeClient) return;
    try {
        const response = await fetch(`/admin/api/chat/messages?client=${activeClient}`);
        const data = await response.json();
        if (data.messages) {
            const container = document.getElementById('chatMessages');
            container.innerHTML = '';
            data.messages.forEach(msg => {
                const group = document.createElement('div');
                group.className = `message-group ${msg.sender === 'bot' ? 'sent' : 'received'}`;
                group.innerHTML = `
                    <div class="message-bubble ${msg.sender === 'bot' ? 'sent' : 'received'}">
                        <div>${msg.message}</div>
                        <div class="message-time">${msg.timestamp.substring(11, 16)}</div>
                    </div>
                `;
                container.appendChild(group);
            });
            container.scrollTop = container.scrollHeight;
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
    }
}

async function saveNotes() {
    if (!activeClient) return;
    const notes = document.getElementById('clientNotes').value;
    try {
        const response = await fetch(`/admin/api/clients/${activeClient}/notes`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ notes: notes })
        });
        const data = await response.json();
        if (data.success) showNotification('–ó–∞–º–µ—Ç–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
    } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
    }
}

function attachFile() {
    document.getElementById('fileInput').click();
}

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file || file.size > 10 * 1024 * 1024) {
        showNotification('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π', 'error');
        return;
    }
    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
}

if (activeClient) {
    setTimeout(() => {
        const container = document.getElementById('chatMessages');
        if (container) container.scrollTop = container.scrollHeight;
    }, 100);
    setInterval(loadMessages, 3000);
}
</script>
{% endblock %}