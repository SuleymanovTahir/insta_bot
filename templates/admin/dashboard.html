{% extends "admin/base.html" %}

{% block title %}Панель управления - {{ salon_info.name }}{% endblock %}

{% block nav_dashboard %}active{% endblock %}

{% block head_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <h1 class="page-title">
        <i class="fas fa-home gradient-text"></i>
        Панель управления
    </h1>
    <p class="page-subtitle">Добро пожаловать в CRM-систему салона красоты</p>
</div>

<!-- Stats Grid -->
<div class="stats-grid">
    <!-- Total Clients -->
    <div class="stat-card card-hover">
        <div class="stat-card-header">
            <div class="stat-card-icon stat-card-icon-blue">
                <i class="fas fa-users"></i>
            </div>
        </div>
        <div class="stat-card-value">{{ stats.total_clients }}</div>
        <div class="stat-card-label">Всего клиентов</div>
        <div class="stat-card-trend">
            <span class="trend-up">
                <i class="fas fa-arrow-up"></i> +12%
            </span>
            <span class="trend-neutral">за месяц</span>
        </div>
    </div>

    <!-- Total Bookings -->
    <div class="stat-card card-hover">
        <div class="stat-card-header">
            <div class="stat-card-icon stat-card-icon-pink">
                <i class="fas fa-calendar-check"></i>
            </div>
        </div>
        <div class="stat-card-value">{{ stats.total_bookings }}</div>
        <div class="stat-card-label">Всего записей</div>
        <div class="stat-card-trend">
            <span class="trend-up">
                <i class="fas fa-arrow-up"></i> +8%
            </span>
            <span class="trend-neutral">за месяц</span>
        </div>
    </div>

    <!-- Completed Bookings -->
    <div class="stat-card card-hover">
        <div class="stat-card-header">
            <div class="stat-card-icon stat-card-icon-green">
                <i class="fas fa-check-circle"></i>
            </div>
        </div>
        <div class="stat-card-value">{{ stats.completed_bookings }}</div>
        <div class="stat-card-label">Завершенных</div>
        <div class="stat-card-trend">
            <span class="trend-up">
                <i class="fas fa-arrow-up"></i> +15%
            </span>
            <span class="trend-neutral">за месяц</span>
        </div>
    </div>

    <!-- Conversion Rate -->
    <div class="stat-card card-hover">
        <div class="stat-card-header">
            <div class="stat-card-icon stat-card-icon-purple">
                <i class="fas fa-percentage"></i>
            </div>
        </div>
        <div class="stat-card-value">{{ stats.conversion_rate }}%</div>
        <div class="stat-card-label">Конверсия</div>
        <div class="stat-card-trend">
            <span class="trend-up">
                <i class="fas fa-arrow-up"></i> +3%
            </span>
            <span class="trend-neutral">за месяц</span>
        </div>
    </div>
</div>

<!-- Charts Grid -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
    <!-- Bookings Chart -->
    <div class="table-container" style="padding: 1.5rem;">
        <h2 style="font-size: 1.25rem; font-weight: 700; color: #111827; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-chart-line" style="color: #ec4899;"></i>
            Записи за 30 дней
        </h2>
        <div style="height: 300px;">
            <canvas id="bookingsChart"></canvas>
        </div>
    </div>

    <!-- Services Chart -->
    <div class="table-container" style="padding: 1.5rem;">
        <h2 style="font-size: 1.25rem; font-weight: 700; color: #111827; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-chart-pie" style="color: #8b5cf6;"></i>
            Популярные услуги
        </h2>
        <div style="height: 300px;">
            <canvas id="servicesChart"></canvas>
        </div>
    </div>
</div>

<!-- Recent Activity Grid -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem;">
    <!-- Recent Clients -->
    <div class="table-container">
        <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb;">
            <h2 style="font-size: 1.25rem; font-weight: 700; color: #111827; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-user-plus" style="color: #3b82f6;"></i>
                Последние клиенты
            </h2>
        </div>
        <div style="overflow-x: auto;">
            <table class="table">
                <thead>
                    <tr>
                        <th>Имя</th>
                        <th>Телефон</th>
                        <th>Статус</th>
                    </tr>
                </thead>
                <tbody>
                    {% for client in recent_clients %}
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="width: 36px; height: 36px; border-radius: 0.5rem; background: linear-gradient(135deg, #ec4899, #8b5cf6); color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.875rem;">
                                    {{ client[3][0] if client[3] else '?' }}
                                </div>
                                <span style="font-weight: 600;">{{ client[3] or 'Не указано' }}</span>
                            </div>
                        </td>
                        <td style="color: #6b7280;">{{ client[2] or '-' }}</td>
                        <td>
                            <span class="badge badge-{{ client[8] }}">{{ client[8] }}</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Recent Bookings -->
    <div class="table-container">
        <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb;">
            <h2 style="font-size: 1.25rem; font-weight: 700; color: #111827; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-calendar-alt" style="color: #ec4899;"></i>
                Последние записи
            </h2>
        </div>
        <div style="overflow-x: auto;">
            <table class="table">
                <thead>
                    <tr>
                        <th>Услуга</th>
                        <th>Клиент</th>
                        <th>Дата</th>
                    </tr>
                </thead>
                <tbody>
                    {% for booking in recent_bookings %}
                    <tr>
                        <td style="font-weight: 600;">{{ booking[2] }}</td>
                        <td style="color: #6b7280;">{{ booking[5] }}</td>
                        <td style="color: #6b7280;">{{ booking[3][:16] }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Bookings Chart
const bookingsCtx = document.getElementById('bookingsChart').getContext('2d');
const bookingsChart = new Chart(bookingsCtx, {
    type: 'line',
    data: {
        labels: {{ analytics.bookings_by_day | map(attribute=0) | list | tojson }},
        datasets: [{
            label: 'Записи',
            data: {{ analytics.bookings_by_day | map(attribute=1) | list | tojson }},
            borderColor: '#ec4899',
            backgroundColor: 'rgba(236, 72, 153, 0.1)',
            tension: 0.4,
            fill: true,
            borderWidth: 3,
            pointBackgroundColor: '#ec4899',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 5,
            pointHoverRadius: 7
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: '#111827',
                padding: 12,
                cornerRadius: 8,
                titleFont: {
                    size: 14,
                    weight: 'bold'
                },
                bodyFont: {
                    size: 13
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(0, 0, 0, 0.05)',
                    drawBorder: false
                },
                ticks: {
                    font: {
                        size: 12
                    },
                    color: '#6b7280'
                }
            },
            x: {
                grid: {
                    display: false,
                    drawBorder: false
                },
                ticks: {
                    font: {
                        size: 12
                    },
                    color: '#6b7280'
                }
            }
        }
    }
});

// Services Chart
const servicesCtx = document.getElementById('servicesChart').getContext('2d');
const servicesChart = new Chart(servicesCtx, {
    type: 'doughnut',
    data: {
        labels: {{ analytics.services_stats | map(attribute=0) | list | tojson }},
        datasets: [{
            data: {{ analytics.services_stats | map(attribute=1) | list | tojson }},
            backgroundColor: [
                '#ec4899',
                '#8b5cf6',
                '#3b82f6',
                '#10b981',
                '#f59e0b',
                '#ef4444'
            ],
            borderWidth: 0,
            hoverOffset: 10
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 15,
                    font: {
                        size: 12
                    },
                    color: '#6b7280',
                    usePointStyle: true,
                    pointStyle: 'circle'
                }
            },
            tooltip: {
                backgroundColor: '#111827',
                padding: 12,
                cornerRadius: 8,
                titleFont: {
                    size: 14,
                    weight: 'bold'
                },
                bodyFont: {
                    size: 13
                }
            }
        }
    }
});
</script>
{% endblock %}