{% extends "admin/base.html" %}

{% block title %}Панель управления - {{ salon_info.name }}{% endblock %}
{% block nav_dashboard %}active{% endblock %}

{% block head_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<!-- Заголовок -->
<div style="margin-bottom: 2rem;">
    <h1 style="font-size: 2rem; font-weight: 700; color: #111827; margin-bottom: 0.5rem;">
        Панель управления
    </h1>
    <p style="color: #6b7280; font-size: 1rem;">
        Статистика и последние обновления
    </p>
</div>

<!-- Карточки статистики -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
    <!-- Клиенты -->
    <div class="stat-card">
        <div class="stat-card-icon" style="background: linear-gradient(135deg, #dbeafe, #bfdbfe);">
            <i class="fas fa-users" style="color: #1e40af; font-size: 1.5rem;"></i>
        </div>
        <div class="stat-card-value" style="color: #111827;">{{ stats.total_clients }}</div>
        <div class="stat-card-label" style="color: #6b7280;">Клиентов</div>
    </div>

    <!-- Записи -->
    <div class="stat-card">
        <div class="stat-card-icon" style="background: linear-gradient(135deg, #fce7f3, #fbcfe8);">
            <i class="fas fa-calendar-check" style="color: #be185d; font-size: 1.5rem;"></i>
        </div>
        <div class="stat-card-value" style="color: #111827;">{{ stats.total_bookings }}</div>
        <div class="stat-card-label" style="color: #6b7280;">Записей</div>
    </div>

    <!-- Завершено -->
    <div class="stat-card">
        <div class="stat-card-icon" style="background: linear-gradient(135deg, #dcfce7, #bbf7d0);">
            <i class="fas fa-check-circle" style="color: #15803d; font-size: 1.5rem;"></i>
        </div>
        <div class="stat-card-value" style="color: #111827;">{{ stats.completed_bookings }}</div>
        <div class="stat-card-label" style="color: #6b7280;">Завершено</div>
    </div>

    <!-- Конверсия -->
    <div class="stat-card">
        <div class="stat-card-icon" style="background: linear-gradient(135deg, #e9d5ff, #ddd6fe);">
            <i class="fas fa-percentage" style="color: #7e22ce; font-size: 1.5rem;"></i>
        </div>
        <div class="stat-card-value" style="color: #111827;">{{ stats.conversion_rate }}%</div>
        <div class="stat-card-label" style="color: #6b7280;">Конверсия</div>
    </div>
</div>

<!-- Графики -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
    <!-- График записей -->
    <div class="card">
        <div class="card-header">
            <h2 style="font-size: 1.25rem; font-weight: 700; color: #111827;">
                <i class="fas fa-chart-line" style="color: #667eea; margin-right: 0.5rem;"></i>
                Записи (30 дней)
            </h2>
        </div>
        <div class="card-body">
            <div style="height: 300px; position: relative;">
                <canvas id="bookingsChart"></canvas>
            </div>
        </div>
    </div>

    <!-- График услуг -->
    <div class="card">
        <div class="card-header">
            <h2 style="font-size: 1.25rem; font-weight: 700; color: #111827;">
                <i class="fas fa-chart-pie" style="color: #ec4899; margin-right: 0.5rem;"></i>
                Популярные услуги
            </h2>
        </div>
        <div class="card-body">
            <div style="height: 300px; position: relative;">
                <canvas id="servicesChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Последние клиенты и записи -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
    <!-- Последние клиенты -->
    <div class="card">
        <div class="card-header">
            <h2 style="font-size: 1.25rem; font-weight: 700; color: #111827;">
                <i class="fas fa-user-plus" style="color: #3b82f6; margin-right: 0.5rem;"></i>
                Последние клиенты
            </h2>
        </div>
        <div class="card-body">
            {% if recent_clients %}
                {% for client in recent_clients %}
                <div style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem 0; border-bottom: 1px solid #f3f4f6;">
                    <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #ec4899, #8b5cf6); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                        {{ client[3][0] if client[3] else '?' }}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #111827;">{{ client[3] or 'Не указано' }}</div>
                        <div style="font-size: 0.875rem; color: #6b7280;">{{ client[2] or '-' }}</div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p style="color: #9ca3af; text-align: center; padding: 2rem 0;">Нет клиентов</p>
            {% endif %}
        </div>
    </div>

    <!-- Последние записи -->
    <div class="card">
        <div class="card-header">
            <h2 style="font-size: 1.25rem; font-weight: 700; color: #111827;">
                <i class="fas fa-calendar-alt" style="color: #ec4899; margin-right: 0.5rem;"></i>
                Последние записи
            </h2>
        </div>
        <div class="card-body">
            {% if recent_bookings %}
                {% for booking in recent_bookings %}
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-bottom: 1px solid #f3f4f6;">
                    <div>
                        <div style="font-weight: 600; color: #111827;">{{ booking[2] }}</div>
                        <div style="font-size: 0.875rem; color: #6b7280;">{{ booking[5] }}</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 0.875rem; color: #6b7280;">{{ booking[3][:16] }}</div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p style="color: #9ca3af; text-align: center; padding: 2rem 0;">Нет записей</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Графики
const bookingsCtx = document.getElementById('bookingsChart');
if (bookingsCtx && {{ analytics.bookings_by_day | tojson }} ) {
    new Chart(bookingsCtx.getContext('2d'), {
        type: 'line',
        data: {
            labels: {{ analytics.bookings_by_day | map(attribute=0) | list | tojson }},
            datasets: [{
                label: 'Записи',
                data: {{ analytics.bookings_by_day | map(attribute=1) | list | tojson }},
                borderColor: '#ec4899',
                backgroundColor: 'rgba(236, 72, 153, 0.1)',
                tension: 0.4,
                fill: true,
                borderWidth: 3,
                pointRadius: 5,
                pointHoverRadius: 7
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, grid: { color: 'rgba(0, 0, 0, 0.05)' } }
            }
        }
    });
}

const servicesCtx = document.getElementById('servicesChart');
if (servicesCtx && {{ analytics.services_stats | tojson }} ) {
    new Chart(servicesCtx.getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: {{ analytics.services_stats | map(attribute=0) | list | tojson }},
            datasets: [{
                data: {{ analytics.services_stats | map(attribute=1) | list | tojson }},
                backgroundColor: ['#ec4899', '#8b5cf6', '#3b82f6', '#10b981', '#f59e0b', '#ef4444'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom', labels: { font: { size: 12 }, padding: 15 } } }
        }
    });
}
</script>
{% endblock %}