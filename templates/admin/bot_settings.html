{% extends "admin/base.html" %}

{% block title %}–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞ - {{ salon_info.name }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ü§ñ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞</h1>
    <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ–º AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞</p>
</div>

<!-- –í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ –∑–∞–≥—Ä—É–∑–∫–∏ -->
<div class="chart-container" style="margin-bottom: 30px;">
    <h2><i class="fas fa-upload"></i> –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π</h2>
    <div style="padding: 20px;">
        <div style="display: flex; gap: 20px; margin-bottom: 30px;">
            <button class="btn btn-primary" onclick="loadFromFile()" style="flex: 1;">
                <i class="fas fa-file-import"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ —Ñ–∞–π–ª–∞
            </button>
            <button class="btn btn-secondary" onclick="showManualForm()" style="flex: 1;">
                <i class="fas fa-edit"></i> –ó–∞–ø–æ–ª–Ω–∏—Ç—å –≤—Ä—É—á–Ω—É—é
            </button>
        </div>
        
        <div class="message-box" style="background: linear-gradient(135deg, #dbeafe, #bfdbfe); border-left: 5px solid #3b82f6;">
            <div class="message-header">
                <span><i class="fas fa-info-circle"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</span>
            </div>
            <div class="message-text">
                <strong>–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ —Ñ–∞–π–ª–∞:</strong> –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ bot_instructions.txt (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞)<br>
                <strong>–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—Ä—É—á–Ω—É—é:</strong> –ü–æ–∑–≤–æ–ª—è–µ—Ç –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–∞–∂–¥—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ
            </div>
        </div>
    </div>
</div>

<!-- –§–æ—Ä–º–∞ —Ä—É—á–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
<div id="manualSettingsForm" style="display: none;">
    <form id="botSettingsForm" onsubmit="saveSettings(event)">
        
        <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
        <div class="chart-container" style="margin-bottom: 30px;">
            <h2><i class="fas fa-cog"></i> –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            <div style="padding: 20px;">
                <div class="form-group">
                    <label class="form-label">–†–æ–ª—å –±–æ—Ç–∞</label>
                    <textarea class="form-textarea" id="botRole" rows="3" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –¢—ã ‚Äî –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —ç–ª–∏—Ç–Ω–æ–≥–æ —Å–∞–ª–æ–Ω–∞ –∫—Ä–∞—Å–æ—Ç—ã..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">–ú–∏—Å—Å–∏—è</label>
                    <textarea class="form-textarea" id="botMission" rows="2" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ –Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å –Ω–∞ –æ–Ω–ª–∞–π–Ω-–∑–∞–ø–∏—Å—å..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">–õ–∏—á–Ω–æ—Å—Ç—å –±–æ—Ç–∞ (—á–µ—Ä–µ–∑ |)</label>
                    <input type="text" class="form-input" id="botPersonality" placeholder="–û–±–∞—è—Ç–µ–ª—å–Ω–∞—è|–£–≤–µ—Ä–µ–Ω–Ω–∞—è|–•–∞—Ä–∏–∑–º–∞—Ç–∏—á–Ω–∞—è|–≠–∫—Å–ø–µ—Ä—Ç">
                </div>
            </div>
        </div>

        <!-- –°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è -->
        <div class="chart-container" style="margin-bottom: 30px;">
            <h2><i class="fas fa-comments"></i> –°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è</h2>
            <div style="padding: 20px;">
                <div class="form-group">
                    <label class="form-label">–¢–æ–Ω –æ–±—â–µ–Ω–∏—è</label>
                    <select class="form-select" id="botTone">
                        <option value="friendly">–î—Ä—É–∂–µ–ª—é–±–Ω—ã–π</option>
                        <option value="professional">–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π</option>
                        <option value="enthusiastic">–í–æ—Å—Ç–æ—Ä–∂–µ–Ω–Ω—ã–π</option>
                        <option value="expert">–≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–π</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞ (–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π)</label>
                    <input type="number" class="form-input" id="maxResponseLength" value="4" min="2" max="10">
                </div>
                
                <div class="form-group">
                    <label class="form-label">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —ç–º–æ–¥–∑–∏</label>
                    <select class="form-select" id="emojiUsage">
                        <option value="moderate">–£–º–µ—Ä–µ–Ω–Ω–æ–µ (2-3 –∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ)</option>
                        <option value="minimal">–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ (1 –∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ)</option>
                        <option value="none">–ë–µ–∑ —ç–º–æ–¥–∑–∏</option>
                        <option value="maximum">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ (4-5 –∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —è–∑—ã–∫–∏</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                ${settings.justifyPrices ? '<span class="badge badge-success"><i class="fas fa-check"></i> –û–ø—Ä–∞–≤–¥–∞–Ω–∏–µ —Ü–µ–Ω</span>' : ''}
                ${settings.mentionQuality ? '<span class="badge badge-success"><i class="fas fa-check"></i> –£–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞</span>' : ''}
                ${settings.emphasizeDuration ? '<span class="badge badge-success"><i class="fas fa-check"></i> –î–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å</span>' : ''}
                ${settings.createUrgency ? '<span class="badge badge-success"><i class="fas fa-check"></i> FOMO</span>' : ''}
                ${settings.useCompliments ? '<span class="badge badge-success"><i class="fas fa-check"></i> –ö–æ–º–ø–ª–∏–º–µ–Ω—Ç—ã</span>' : ''}
                ${settings.personalApproach ? '<span class="badge badge-success"><i class="fas fa-check"></i> –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è</span>' : ''}
                ${settings.upsellTechniques ? '<span class="badge badge-success"><i class="fas fa-check"></i> Upsell</span>' : ''}
            </div>
        </div>
        
        ${settings.role ? `
        <div style="margin-top: 25px; padding-top: 25px; border-top: 2px solid #e5e7eb;">
            <h3 style="margin-bottom: 10px; color: #1f2937;">–†–æ–ª—å –±–æ—Ç–∞:</h3>
            <p style="color: #6b7280; line-height: 1.6;">${settings.role}</p>
        </div>
        ` : ''}
        
        ${settings.mission ? `
        <div style="margin-top: 20px;">
            <h3 style="margin-bottom: 10px; color: #1f2937;">–ú–∏—Å—Å–∏—è:</h3>
            <p style="color: #6b7280; line-height: 1.6;">${settings.mission}</p>
        </div>
        ` : ''}
    `;
}

async function resetToDefaults() {
    if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é?')) return;
    
    try {
        const response = await fetch('/admin/api/bot-settings/reset', {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–±—Ä–æ—à–µ–Ω—ã', 'success');
            setTimeout(() => location.reload(), 1000);
        }
    } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞', 'error');
    }
}

async function previewBot() {
    const testMessage = prompt('–í–≤–µ–¥–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –±–æ—Ç–∞:', '–ü—Ä–∏–≤–µ—Ç! –°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –º–∞–Ω–∏–∫—é—Ä?');
    
    if (!testMessage) return;
    
    try {
        const response = await fetch('/admin/api/bot-settings/preview', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ message: testMessage })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`–û—Ç–≤–µ—Ç –±–æ—Ç–∞:\n\n${data.response}`);
        }
    } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞', 'error');
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', async function() {
    try {
        const response = await fetch('/admin/api/bot-settings/current');
        const data = await response.json();
        
        if (data.success && data.settings) {
            displayCurrentSettings(data.settings);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
    }
});
</script>
{% endblock %} gap: 20px; margin-top: 10px;">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" class="form-checkbox" name="languages" value="ru" checked>
                            <span>–†—É—Å—Å–∫–∏–π</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" class="form-checkbox" name="languages" value="en" checked>
                            <span>English</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" class="form-checkbox" name="languages" value="ar">
                            <span>ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∏–ª–∞ –æ —Ü–µ–Ω–∞—Ö -->
        <div class="chart-container" style="margin-bottom: 30px;">
            <h2><i class="fas fa-dollar-sign"></i> –ü—Ä–∞–≤–∏–ª–∞ –æ —Ü–µ–Ω–∞—Ö</h2>
            <div style="padding: 20px;">
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" class="form-checkbox" id="justifyPrices" checked>
                        <span>–û–ø—Ä–∞–≤–¥—ã–≤–∞—Ç—å —Ü–µ–Ω—É —Ü–µ–Ω–Ω–æ—Å—Ç—å—é (–Ω–µ –ø—Ä–æ—Å—Ç–æ –Ω–∞–∑—ã–≤–∞—Ç—å —Ü–∏—Ñ—Ä—É)</span>
                    </label>
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" class="form-checkbox" id="mentionQuality" checked>
                        <span>–£–ø–æ–º–∏–Ω–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∏ –º–∞—Å—Ç–µ—Ä–æ–≤</span>
                    </label>
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" class="form-checkbox" id="emphasizeDuration" checked>
                        <span>–ü–æ–¥—á—ë—Ä–∫–∏–≤–∞—Ç—å –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞</span>
                    </label>
                </div>

                <div class="form-group">
                    <label class="form-label">–°—Ç—Ä–∞—Ç–µ–≥–∏—è –ø—Ä–∏ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–∏ "–¥–æ—Ä–æ–≥–æ"</label>
                    <select class="form-select" id="expensiveStrategy">
                        <option value="premium">–ü–æ–¥—á–µ—Ä–∫–Ω—É—Ç—å –ø—Ä–µ–º–∏—É–º-—Å–µ–≥–º–µ–Ω—Ç</option>
                        <option value="value">–û–±—ä—è—Å–Ω–∏—Ç—å —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Ü–µ–Ω–∞/–∫–∞—á–µ—Å—Ç–≤–æ</option>
                        <option value="comparison">–°—Ä–∞–≤–Ω–∏—Ç—å —Å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞–º–∏</option>
                        <option value="discount">–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∏–ª–∞ –æ –∑–∞–ø–∏—Å–∏ -->
        <div class="chart-container" style="margin-bottom: 30px;">
            <h2><i class="fas fa-calendar-check"></i> –ü—Ä–∞–≤–∏–ª–∞ –æ –∑–∞–ø–∏—Å–∏</h2>
            <div style="padding: 20px;">
                <div class="message-box" style="background: linear-gradient(135deg, #fef3c7, #fde68a); border-left: 5px solid #f59e0b; margin-bottom: 20px;">
                    <div class="message-header">
                        <span><i class="fas fa-exclamation-triangle"></i> –í–∞–∂–Ω–æ</span>
                    </div>
                    <div class="message-text">
                        –ë–æ—Ç –ù–ï –º–æ–∂–µ—Ç –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–∞–ø—Ä—è–º—É—é. –û–Ω –¥–æ–ª–∂–µ–Ω –Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å –Ω–∞ –æ–Ω–ª–∞–π–Ω-–∑–∞–ø–∏—Å—å.
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–Ω–ª–∞–π–Ω-–∑–∞–ø–∏—Å—å</label>
                    <input type="url" class="form-input" id="bookingUrl" value="{{ salon_info.booking_url }}" placeholder="https://...">
                </div>

                <div class="form-group">
                    <label class="form-label">–¢–µ–∫—Å—Ç –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∑–∞–ø–∏—Å–∏</label>
                    <textarea class="form-textarea" id="bookingMessage" rows="4" placeholder="–Ø AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∏ –Ω–µ –º–æ–≥—É –∑–∞–ø–∏—Å–∞—Ç—å –≤–∞—Å –Ω–∞–ø—Ä—è–º—É—é, –Ω–æ —ç—Ç–æ –ª–µ–≥–∫–æ —Å–¥–µ–ª–∞—Ç—å –æ–Ω–ª–∞–π–Ω! üéØ..."></textarea>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" class="form-checkbox" id="createUrgency" checked>
                        <span>–°–æ–∑–¥–∞–≤–∞—Ç—å –æ—â—É—â–µ–Ω–∏–µ —Å—Ä–æ—á–Ω–æ—Å—Ç–∏ (FOMO)</span>
                    </label>
                    <small class="form-help">–ù–∞–ø—Ä–∏–º–µ—Ä: "–ù–∞ —ç—Ç—É –Ω–µ–¥–µ–ª—é —É–∂–µ –º–∞–ª–æ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –æ–∫–æ–Ω..."</small>
                </div>
            </div>
        </div>

        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏ -->
        <div class="chart-container" style="margin-bottom: 30px;">
            <h2><i class="fas fa-lightbulb"></i> –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏</h2>
            <div style="padding: 20px;">
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" class="form-checkbox" id="useCompliments" checked>
                        <span>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç—ã</span>
                    </label>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" class="form-checkbox" id="personalApproach" checked>
                        <span>–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥</span>
                    </label>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" class="form-checkbox" id="upsellTechniques">
                        <span>Upsell —Ç–µ—Ö–Ω–∏–∫–∏ (–ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏)</span>
                    </label>
                </div>

                <div class="form-group">
                    <label class="form-label">–ó–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ —Ç–µ–º—ã (—á–µ—Ä–µ–∑ |)</label>
                    <input type="text" class="form-input" id="forbiddenTopics" placeholder="–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã|–ü–æ–ª–∏—Ç–∏–∫–∞|–†–µ–ª–∏–≥–∏—è">
                </div>
            </div>
        </div>

        <!-- –ü—Ä–∏–º–µ—Ä—ã –æ—Ç–≤–µ—Ç–æ–≤ -->
        <div class="chart-container" style="margin-bottom: 30px;">
            <h2><i class="fas fa-comment-dots"></i> –ü—Ä–∏–º–µ—Ä—ã –æ—Ç–≤–µ—Ç–æ–≤</h2>
            <div style="padding: 20px;">
                <div class="form-group">
                    <label class="form-label">–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ</label>
                    <textarea class="form-textarea" id="greetingExample" rows="2" placeholder="–ü—Ä–∏–≤–µ—Ç! üòä –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ M.Le Diamant!"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">–û—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –æ —Ü–µ–Ω–µ</label>
                    <textarea class="form-textarea" id="priceExample" rows="3" placeholder="Gelish –º–∞–Ω–∏–∫—é—Ä - 130 AED üíÖ –≠—Ç–æ —è–ø–æ–Ω—Å–∫–∏–π –≥–µ–ª—å-–ª–∞–∫..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">–û—Ç–≤–µ—Ç –Ω–∞ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–µ</label>
                    <textarea class="form-textarea" id="objectionExample" rows="3" placeholder="–ú—ã –≤ –ø—Ä–µ–º–∏—É–º-—Å–µ–≥–º–µ–Ω—Ç–µ üíé –ó–∞—Ç–æ..."></textarea>
                </div>
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è -->
        <div style="display: flex; gap: 15px; margin-top: 30px;">
            <button type="submit" class="btn btn-primary" style="flex: 1;">
                <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            </button>
            <button type="button" class="btn btn-secondary" onclick="resetToDefaults()">
                <i class="fas fa-undo"></i> –°–±—Ä–æ—Å–∏—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            </button>
            <button type="button" class="btn btn-info" onclick="previewBot()">
                <i class="fas fa-eye"></i> –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
            </button>
        </div>
    </form>
</div>

<!-- –¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
<div class="chart-container" style="margin-top: 30px;">
    <h2><i class="fas fa-list-check"></i> –¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞</h2>
    <div id="currentSettings" style="padding: 20px;">
        <p style="color: #6b7280;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ —Ñ–∞–π–ª–∞ –∏–ª–∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É...</p>
    </div>
</div>

<style>
.form-checkbox {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

.form-help {
    display: block;
    color: #6b7280;
    font-size: 0.85em;
    margin-top: 5px;
    margin-left: 28px;
}

.message-box {
    padding: 16px 20px;
    border-radius: 12px;
    margin-bottom: 15px;
}

.message-header {
    font-weight: 700;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 1.05em;
}

.message-text {
    line-height: 1.6;
}
</style>

<script>
async function loadFromFile() {
    try {
        const response = await fetch('/admin/api/bot-settings/load-from-file', {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            displayCurrentSettings(data.settings);
            showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ —Ñ–∞–π–ª–∞', 'success');
        } else {
            showNotification(data.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', 'error');
        }
    } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
    }
}

function showManualForm() {
    document.getElementById('manualSettingsForm').style.display = 'block';
    document.getElementById('manualSettingsForm').scrollIntoView({ behavior: 'smooth' });
}

async function saveSettings(event) {
    event.preventDefault();
    
    const settings = {
        role: document.getElementById('botRole').value,
        mission: document.getElementById('botMission').value,
        personality: document.getElementById('botPersonality').value.split('|'),
        tone: document.getElementById('botTone').value,
        maxResponseLength: parseInt(document.getElementById('maxResponseLength').value),
        emojiUsage: document.getElementById('emojiUsage').value,
        languages: Array.from(document.querySelectorAll('input[name="languages"]:checked')).map(el => el.value),
        justifyPrices: document.getElementById('justifyPrices').checked,
        mentionQuality: document.getElementById('mentionQuality').checked,
        emphasizeDuration: document.getElementById('emphasizeDuration').checked,
        expensiveStrategy: document.getElementById('expensiveStrategy').value,
        bookingUrl: document.getElementById('bookingUrl').value,
        bookingMessage: document.getElementById('bookingMessage').value,
        createUrgency: document.getElementById('createUrgency').checked,
        useCompliments: document.getElementById('useCompliments').checked,
        personalApproach: document.getElementById('personalApproach').checked,
        upsellTechniques: document.getElementById('upsellTechniques').checked,
        forbiddenTopics: document.getElementById('forbiddenTopics').value.split('|'),
        examples: {
            greeting: document.getElementById('greetingExample').value,
            price: document.getElementById('priceExample').value,
            objection: document.getElementById('objectionExample').value
        }
    };
    
    try {
        const response = await fetch('/admin/api/bot-settings/save', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(settings)
        });
        
        const data = await response.json();
        
        if (data.success) {
            displayCurrentSettings(settings);
            showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
        } else {
            showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
        }
    } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
    }
}

function displayCurrentSettings(settings) {
    const container = document.getElementById('currentSettings');
    
    container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
            <div class="stat-card">
                <div class="stat-card-content">
                    <div class="stat-card-info">
                        <h3>${settings.tone || '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}</h3>
                        <p>–¢–æ–Ω –æ–±—â–µ–Ω–∏—è</p>
                    </div>
                    <div class="stat-card-icon">
                        <i class="fas fa-comments"></i>
                    </div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-card-content">
                    <div class="stat-card-info">
                        <h3>${settings.maxResponseLength || 4}</h3>
                        <p>–ú–∞–∫—Å. –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π</p>
                    </div>
                    <div class="stat-card-icon">
                        <i class="fas fa-align-left"></i>
                    </div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-card-content">
                    <div class="stat-card-info">
                        <h3>${settings.languages ? settings.languages.length : 0}</h3>
                        <p>–Ø–∑—ã–∫–æ–≤ –ø–æ–¥–¥–µ—Ä–∂–∫–∏</p>
                    </div>
                    <div class="stat-card-icon">
                        <i class="fas fa-language"></i>
                    </div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-card-content">
                    <div class="stat-card-info">
                        <h3>${settings.emojiUsage || '–£–º–µ—Ä–µ–Ω–Ω–æ–µ'}</h3>
                        <p>–≠–º–æ–¥–∑–∏</p>
                    </div>
                    <div class="stat-card-icon">
                        <i class="fas fa-smile"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div style="margin-top: 25px; padding-top: 25px; border-top: 2px solid #e5e7eb;">
            <h3 style="margin-bottom: 15px; color: #1f2937;">–ê–∫—Ç–∏–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:</h3>
            <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                ${settings.justifyPrices ? '<span class="badge badge-success"><i class="fas fa-check"></i> –û–ø—Ä–∞–≤–¥–∞–Ω–∏–µ —Ü–µ–Ω</span>' : ''}
                ${settings.mentionQuality ? '<span class="badge badge-success"><i class="fas fa-check"></i> –£–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞</span>' : ''}
                ${settings.emphasizeDuration ? '<span class="badge badge-success"><i class="fas fa-check"></i> –î–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å</span>' : ''}
                ${settings.createUrgency ? '<span class="badge badge-success"><i class="fas fa-check"></i> FOMO</span>' : ''}
                ${settings.useCompliments ? '<span class="badge badge-success"><i class="fas fa-check"></i> –ö–æ–º–ø–ª–∏–º–µ–Ω—Ç—ã</span>' : ''}
                ${settings.personalApproach ? '<span class="badge badge-success"><i class="fas fa-check"></i> –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è</span>' : ''}
                ${settings.upsellTechniques ? '<span class="badge badge-success"><i class="fas fa-check"></i> Upsell</span>' : ''}
            </div>
        </div>
        
        ${settings.role ? `
        <div style="margin-top: 25px; padding-top: 25px; border-top: 2px solid #e5e7eb;">
            <h3 style="margin-bottom: 10px; color: #1f2937;">–†–æ–ª—å –±–æ—Ç–∞:</h3>
            <p style="color: #6b7280; line-height: 1.6;">${settings.role}</p>
        </div>
        ` : ''}
        
        ${settings.mission ? `
        <div style="margin-top: 20px;">
            <h3 style="margin-bottom: 10px; color: #1f2937;">–ú–∏—Å—Å–∏—è:</h3>
            <p style="color: #6b7280; line-height: 1.6;">${settings.mission}</p>
        </div>
        ` : ''}
    `;
}

async function resetToDefaults() {
    if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é?')) return;
    
    try {
        const response = await fetch('/admin/api/bot-settings/reset', {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–±—Ä–æ—à–µ–Ω—ã', 'success');
            setTimeout(() => location.reload(), 1000);
        }
    } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞', 'error');
    }
}

async function previewBot() {
    const testMessage = prompt('–í–≤–µ–¥–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –±–æ—Ç–∞:', '–ü—Ä–∏–≤–µ—Ç! –°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –º–∞–Ω–∏–∫—é—Ä?');
    
    if (!testMessage) return;
    
    try {
        const response = await fetch('/admin/api/bot-settings/preview', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ message: testMessage })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`–û—Ç–≤–µ—Ç –±–æ—Ç–∞:\n\n${data.response}`);
        }
    } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞', 'error');
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', async function() {
    try {
        const response = await fetch('/admin/api/bot-settings/current');
        const data = await response.json();
        
        if (data.success && data.settings) {
            displayCurrentSettings(data.settings);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
    }
});
</script>
{% endblock %}