{% extends "admin/base.html" %}

{% block title %}–£—Å–ª—É–≥–∏ - {{ salon_info.name }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üíÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∞–º–∏</h1>
    <p>–ü—Ä–∞–π—Å-–ª–∏—Å—Ç —Å–∞–ª–æ–Ω–∞</p>
</div>

<!-- Search and Filter -->
<div class="search-filter-bar">
    <input type="text" class="search-box" id="searchInput" placeholder="üîç –ü–æ–∏—Å–∫ —É—Å–ª—É–≥..." onkeyup="searchTable()">
    
    <select class="filter-select" id="categoryFilter" onchange="filterByCategory()">
        <option value="all">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
        <option value="Permanent Makeup">Permanent Makeup</option>
        <option value="Facial">Facial</option>
        <option value="Massage">Massage</option>
        <option value="Nails">Nails</option>
        <option value="Hair">Hair</option>
        <option value="Lashes">Lashes</option>
        <option value="Brows">Brows</option>
        <option value="Waxing">Waxing</option>
    </select>

    <button class="btn btn-primary" onclick="openAddModal()">
        <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥—É
    </button>
</div>

<!-- Services Table -->
<div class="data-table-container">
    <table class="data-table" id="servicesTable">
        <thead>
            <tr>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–¶–µ–Ω–∞</th>
                <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody>
            {% if services %}
            {% for service in services %}
            <tr data-category="{{ service[7] }}" data-active="{{ service[11] }}">
                <td>
                    <strong>{{ service[2] }}</strong><br>
                    <small style="color: #6b7280;">{{ service[3] or service[2] }}</small>
                </td>
                <td><strong>{{ service[5] }} {{ service[6] }}</strong></td>
                <td><span class="badge badge-info">{{ service[7] }}</span></td>
                <td>
                    <div style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">
                        {{ service[9][:50] if service[9] else '-' }}
                    </div>
                </td>
                <td>
                    {% if service[11] == 1 %}
                    <span class="badge badge-success">–ê–∫—Ç–∏–≤–Ω–∞</span>
                    {% else %}
                    <span class="badge badge-danger">–ù–µ–∞–∫—Ç–∏–≤–Ω–∞</span>
                    {% endif %}
                </td>
                <td>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-sm btn-info" onclick="editService({{ service[0] }})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteService({{ service[0] }})" title="–£–¥–∞–ª–∏—Ç—å">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
            {% else %}
            <tr>
                <td colspan="6">
                    <div class="empty-state">
                        <i class="fas fa-spa"></i>
                        <h3>–ù–µ—Ç —É—Å–ª—É–≥</h3>
                        <p>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é —É—Å–ª—É–≥—É</p>
                    </div>
                </td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<!-- Modal –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
<div class="modal" id="serviceModal">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal()">&times;</span>
        <div class="modal-header">
            <h2 id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥—É</h2>
        </div>
        
        <form id="serviceForm" onsubmit="saveService(event)">
            <input type="hidden" id="serviceId">
            
            <div class="form-group">
                <label class="form-label">–ö–ª—é—á —É—Å–ª—É–≥–∏ (–ª–∞—Ç–∏–Ω–∏—Ü–∞)</label>
                <input type="text" class="form-input" id="serviceKey" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ (EN)</label>
                <input type="text" class="form-input" id="serviceName" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ (RU)</label>
                <input type="text" class="form-input" id="serviceNameRu">
            </div>
            
            <div class="form-group">
                <label class="form-label">–¶–µ–Ω–∞</label>
                <input type="number" class="form-input" id="servicePrice" step="0.01" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">–í–∞–ª—é—Ç–∞</label>
                <select class="form-select" id="serviceCurrency">
                    <option value="AED">AED</option>
                    <option value="USD">USD</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                <select class="form-select" id="serviceCategory" required>
                    <option value="Permanent Makeup">Permanent Makeup</option>
                    <option value="Facial">Facial</option>
                    <option value="Massage">Massage</option>
                    <option value="Nails">Nails</option>
                    <option value="Hair">Hair</option>
                    <option value="Lashes">Lashes</option>
                    <option value="Brows">Brows</option>
                    <option value="Waxing">Waxing</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ (EN)</label>
                <textarea class="form-textarea" id="serviceDescription" rows="3"></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ (RU)</label>
                <textarea class="form-textarea" id="serviceDescriptionRu" rows="3"></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ (—á–µ—Ä–µ–∑ |)</label>
                <input type="text" class="form-input" id="serviceBenefits" placeholder="–ë—ã—Å—Ç—Ä–æ|–ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ|–ù–µ–¥–æ—Ä–æ–≥–æ">
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 25px;">
                <button type="submit" class="btn btn-primary" style="flex: 1;">
                    <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
                <button type="button" class="btn btn-secondary" onclick="closeModal()">
                    <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function searchTable() {
    const input = document.getElementById('searchInput');
    const filter = input.value.toUpperCase();
    const table = document.getElementById('servicesTable');
    const tr = table.getElementsByTagName('tr');

    for (let i = 1; i < tr.length; i++) {
        const td = tr[i].getElementsByTagName('td');
        let found = false;

        for (let j = 0; j < td.length; j++) {
            if (td[j]) {
                const txtValue = td[j].textContent || td[j].innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    found = true;
                    break;
                }
            }
        }

        tr[i].style.display = found ? '' : 'none';
    }
}

function filterByCategory() {
    const select = document.getElementById('categoryFilter');
    const category = select.value;
    const table = document.getElementById('servicesTable');
    const tr = table.getElementsByTagName('tr');

    for (let i = 1; i < tr.length; i++) {
        if (category === 'all') {
            tr[i].style.display = '';
        } else {
            const rowCategory = tr[i].getAttribute('data-category');
            tr[i].style.display = rowCategory === category ? '' : 'none';
        }
    }
}

function openAddModal() {
    document.getElementById('modalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥—É';
    document.getElementById('serviceForm').reset();
    document.getElementById('serviceId').value = '';
    document.getElementById('serviceModal').classList.add('active');
}

function closeModal() {
    document.getElementById('serviceModal').classList.remove('active');
}

async function editService(id) {
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏
    const response = await fetch(`/admin/api/services/${id}`);
    const service = await response.json();
    
    document.getElementById('modalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —É—Å–ª—É–≥—É';
    document.getElementById('serviceId').value = id;
    document.getElementById('serviceKey').value = service.service_key;
    document.getElementById('serviceName').value = service.name;
    document.getElementById('serviceNameRu').value = service.name_ru || '';
    document.getElementById('servicePrice').value = service.price;
    document.getElementById('serviceCurrency').value = service.currency;
    document.getElementById('serviceCategory').value = service.category;
    document.getElementById('serviceDescription').value = service.description || '';
    document.getElementById('serviceDescriptionRu').value = service.description_ru || '';
    document.getElementById('serviceBenefits').value = service.benefits || '';
    
    document.getElementById('serviceModal').classList.add('active');
}

async function saveService(event) {
    event.preventDefault();
    
    const serviceId = document.getElementById('serviceId').value;
    const isEdit = serviceId !== '';
    
    const data = {
        service_key: document.getElementById('serviceKey').value,
        name: document.getElementById('serviceName').value,
        name_ru: document.getElementById('serviceNameRu').value,
        price: document.getElementById('servicePrice').value,
        currency: document.getElementById('serviceCurrency').value,
        category: document.getElementById('serviceCategory').value,
        description: document.getElementById('serviceDescription').value,
        description_ru: document.getElementById('serviceDescriptionRu').value,
        benefits: document.getElementById('serviceBenefits').value
    };
    
    try {
        const url = isEdit ? `/admin/api/services/${serviceId}/update` : '/admin/api/services/create';
        const response = await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification(isEdit ? '–£—Å–ª—É–≥–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞' : '–£—Å–ª—É–≥–∞ —Å–æ–∑–¥–∞–Ω–∞', 'success');
            closeModal();
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification(result.message, 'error');
        }
    } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
    }
}

async function deleteService(id) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —É—Å–ª—É–≥—É?')) return;
    
    try {
        const response = await fetch(`/admin/api/services/${id}/delete`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('–£—Å–ª—É–≥–∞ —É–¥–∞–ª–µ–Ω–∞', 'success');
            setTimeout(() => location.reload(), 1000);
        }
    } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error');
    }
}

window.onclick = function(event) {
    const modal = document.getElementById('serviceModal');
    if (event.target === modal) {
        closeModal();
    }
}
</script>
{% endblock %}